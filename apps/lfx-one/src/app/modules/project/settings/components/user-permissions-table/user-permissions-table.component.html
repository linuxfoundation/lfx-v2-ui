<!-- Copyright The Linux Foundation and each contributor to LFX. -->
<!-- SPDX-License-Identifier: MIT -->
@if (loading()) {
  <div class="flex justify-center items-center min-h-96">
    <div class="text-center">
      <i class="fa-light fa-spinner-third fa-spin text-3xl text-blue-600 mb-4"></i>
      <p class="text-gray-600">Loading user permissions...</p>
    </div>
  </div>
}

@if (!loading()) {
  <lfx-card header="Permissions">
    @if (users().length > 0) {
      <lfx-table
        [value]="users()"
        size="small"
        styleClass="p-datatable-sm animate-fade-in-up"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[10, 25, 50]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} users">
        <ng-template #header>
          <tr>
            <th><span class="text-sm font-sans text-gray-500">User</span></th>
            <th><span class="text-sm font-sans text-gray-500">Permission Scope</span></th>
            <th><span class="text-sm font-sans text-gray-500">Access Level</span></th>
            <th><span class="text-sm font-sans text-gray-500">Details</span></th>
            <th class="text-center">
              <div class="flex justify-center">
                <span class="text-sm font-sans text-gray-500">Actions</span>
              </div>
            </th>
          </tr>
        </ng-template>

        <ng-template #body let-userPermission>
          <tr>
            <!-- User Info Column -->
            <td>
              <div class="flex items-center gap-3">
                <div>
                  <div class="text-sm font-sans text-gray-900 font-medium">{{ userPermission.user.first_name }} {{ userPermission.user.last_name }}</div>
                  <div class="text-sm font-sans text-gray-500">{{ userPermission.user.email }}</div>
                </div>
              </div>
            </td>

            <!-- Permission Scope Column -->
            <td>
              @if (userPermission.projectPermission) {
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"> Project </span>
              } @else if (userPermission.committeePermissions?.length > 0) {
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"> Committee </span>
              } @else {
                <span class="text-sm font-sans text-gray-400">No Access</span>
              }
            </td>

            <!-- Access Level Column -->
            <td>
              @if (userPermission.projectPermission) {
                <span class="text-sm font-sans {{ userPermission.projectPermission.level === 'write' ? 'text-green-700 font-medium' : 'text-blue-600' }}">
                  {{ userPermission.projectPermission.level === 'write' ? 'Manage' : 'View' }}
                </span>
              } @else if (userPermission.committeePermissions?.length > 0) {
                <span class="text-sm font-sans {{ userPermission.committeePermissions[0].level === 'write' ? 'text-green-700 font-medium' : 'text-blue-600' }}">
                  {{ userPermission.committeePermissions[0].level === 'write' ? 'Manage' : 'View' }}
                </span>
              } @else {
                <span class="text-sm font-sans text-gray-400">-</span>
              }
            </td>

            <!-- Details Column -->
            <td>
              @if (userPermission.projectPermission) {
                <span class="text-sm font-sans text-gray-600">All committees, meetings, and mailing lists</span>
              } @else if (userPermission.committeePermissions?.length > 0) {
                <div class="text-sm font-sans text-gray-600">
                  @if (userPermission.committeePermissions.length === 1) {
                    {{ userPermission.committeePermissions[0].committee.name }}
                  } @else {
                    <span [pTooltip]="userPermission.committeePermissions | committeeNames" tooltipPosition="top">
                      {{ userPermission.committeePermissions.length }} committees
                    </span>
                  }
                </div>
              } @else {
                <span class="text-sm font-sans text-gray-400">-</span>
              }
            </td>

            <!-- Actions Column -->
            <td class="text-center relative">
              <lfx-menu #userActionMenu [model]="userActionMenuItems" [popup]="true" appendTo="body"></lfx-menu>
              <lfx-button
                [icon]="
                  isRemoving() === (userPermission.user.sid || userPermission.user.id) ? 'fa-light fa-circle-notch fa-spin' : 'fa-light fa-ellipsis-vertical'
                "
                [text]="true"
                [rounded]="true"
                size="small"
                severity="secondary"
                [disabled]="isRemoving() === (userPermission.user.sid || userPermission.user.id)"
                (onClick)="toggleUserActionMenu($event, userPermission, userActionMenu)"
                data-testid="user-actions-menu">
              </lfx-button>
            </td>
          </tr>
        </ng-template>

        <ng-template #emptymessage>
          <tr>
            <td colspan="6" class="text-center py-8">
              <div class="text-center py-8 text-gray-500">
                <i class="fa-light fa-users text-4xl text-gray-400 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No User Permissions</h3>
                <p class="text-gray-600">No users have been assigned permissions to this project yet.</p>
              </div>
            </td>
          </tr>
        </ng-template>
      </lfx-table>
    } @else {
      <div class="flex justify-center items-center h-full">
        <div class="text-center py-8">
          <i class="fa-light fa-users text-4xl text-gray-400 mb-4"></i>
          <h3 class="text-lg font-medium text-gray-900 mb-2">No User Permissions</h3>
          <p class="text-gray-600">No users have been assigned permissions to this project yet.</p>
        </div>
      </div>
    }
  </lfx-card>
}

<!-- Confirmation Dialog -->
<p-confirmDialog></p-confirmDialog>
