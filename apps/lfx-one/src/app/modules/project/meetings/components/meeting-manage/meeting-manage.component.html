<!-- Copyright The Linux Foundation and each contributor to LFX. -->
<!-- SPDX-License-Identifier: MIT -->

<div class="max-w-4xl mx-auto p-6" id="meeting-manage">
  <div class="bg-white rounded-lg border border-slate-200 shadow-sm">
    <!-- Header -->
    <div class="border-b border-slate-200 p-6">
      <div class="flex items-center justify-between">
        <h1 class="text-xl font-semibold text-slate-900" data-testid="meeting-manage-title">
          {{ isEditMode() ? 'Edit Meeting' : 'Create Meeting' }}
        </h1>
        @if (!isEditMode()) {
          <div class="text-sm text-slate-500" data-testid="meeting-manage-step-indicator">Step {{ currentStep() }} of {{ totalSteps }}</div>
        }
      </div>
    </div>

    <!-- Content -->
    <div class="p-8">
      <!-- CREATE MODE: Stepper Layout -->
      @if (!isEditMode()) {
        <p-stepper [value]="currentStep()" [linear]="true" data-testid="meeting-manage-stepper">
          <p-step-list>
            <p-step [value]="1" data-testid="meeting-manage-step-1"></p-step>
            <p-step [value]="2" data-testid="meeting-manage-step-2"></p-step>
            <p-step [value]="3" data-testid="meeting-manage-step-3"></p-step>
            <p-step [value]="4" data-testid="meeting-manage-step-4"></p-step>
            <p-step [value]="5" data-testid="meeting-manage-step-5"></p-step>
          </p-step-list>

          <p-step-panels>
            <p-step-panel [value]="1" data-testid="meeting-manage-panel-0">
              <ng-template #content let-activateCallback="activateCallback">
                <lfx-meeting-type-selection [form]="form()"></lfx-meeting-type-selection>
              </ng-template>
            </p-step-panel>

            <p-step-panel [value]="2" data-testid="meeting-manage-panel-1">
              <ng-template #content let-activateCallback="activateCallback">
                <lfx-meeting-details [form]="form()"></lfx-meeting-details>
              </ng-template>
            </p-step-panel>

            <p-step-panel [value]="3" data-testid="meeting-manage-panel-2">
              <ng-template #content let-activateCallback="activateCallback">
                <lfx-meeting-platform-features [form]="form()"></lfx-meeting-platform-features>
              </ng-template>
            </p-step-panel>

            <p-step-panel [value]="4" data-testid="meeting-manage-panel-3">
              <ng-template #content let-activateCallback="activateCallback">
                <lfx-meeting-resources-summary
                  [form]="form()"
                  [existingAttachments]="attachments()"
                  [isEditMode]="isEditMode()"
                  [deletingAttachmentId]="deletingAttachmentId()"
                  (goToStep)="goToStep($event)"
                  (deleteAttachment)="deleteAttachment($event)">
                </lfx-meeting-resources-summary>
              </ng-template>
            </p-step-panel>

            <p-step-panel [value]="5" data-testid="meeting-manage-panel-4">
              <ng-template #content let-activateCallback="activateCallback">
                @if (meetingId()) {
                  <lfx-meeting-registrants [meetingUid]="meetingId()!" [(registrantUpdates)]="registrantUpdates" [refresh]="registrantUpdatesRefresh$">
                  </lfx-meeting-registrants>
                } @else {
                  <div class="text-center py-8 text-gray-500">
                    <p>Meeting must be created before managing guests.</p>
                  </div>
                }
              </ng-template>
            </p-step-panel>
          </p-step-panels>
        </p-stepper>
      }

      <!-- EDIT MODE: Single Page Layout -->
      @if (isEditMode()) {
        <p-tabs [(value)]="currentStep">
          <p-tablist>
            <p-tab [value]="1">Meeting Details</p-tab>
            <p-tab [value]="2">Manage Guests</p-tab>
          </p-tablist>
          <p-tabpanels>
            <p-tabpanel [value]="1">
              <div class="space-y-8" data-testid="meeting-manage-single-page">
                <!-- Meeting Type Section -->
                <div class="border border-slate-200 rounded-lg p-6">
                  <h2 class="text-lg font-semibold text-slate-900 mb-4">Meeting Type</h2>
                  <lfx-meeting-type-selection [form]="form()"></lfx-meeting-type-selection>
                </div>

                <!-- Meeting Details Section -->
                <div class="border border-slate-200 rounded-lg p-6">
                  <h2 class="text-lg font-semibold text-slate-900 mb-4">Meeting Details</h2>
                  <lfx-meeting-details [form]="form()"></lfx-meeting-details>
                </div>

                <!-- Platform & Features Section -->
                <div class="border border-slate-200 rounded-lg p-6">
                  <h2 class="text-lg font-semibold text-slate-900 mb-4">Platform & Features</h2>
                  <lfx-meeting-platform-features [form]="form()"></lfx-meeting-platform-features>
                </div>

                <!-- Resources & Summary Section -->
                <div class="border border-slate-200 rounded-lg p-6">
                  <h2 class="text-lg font-semibold text-slate-900 mb-4">Resources & Summary</h2>
                  <lfx-meeting-resources-summary
                    [form]="form()"
                    [existingAttachments]="attachments()"
                    [isEditMode]="isEditMode()"
                    [deletingAttachmentId]="deletingAttachmentId()"
                    (goToStep)="goToStep($event)"
                    (deleteAttachment)="deleteAttachment($event)">
                  </lfx-meeting-resources-summary>
                </div>
              </div>
            </p-tabpanel>
            <p-tabpanel [value]="2">
              <!-- Manage Guests Section -->
              <div class="border border-slate-200 rounded-lg p-6">
                <h2 class="text-lg font-semibold text-slate-900 mb-4">Manage Guests</h2>
                <lfx-meeting-registrants [meetingUid]="meetingId()!" [(registrantUpdates)]="registrantUpdates" [refresh]="registrantUpdatesRefresh$">
                </lfx-meeting-registrants>
              </div>
            </p-tabpanel>
          </p-tabpanels>
        </p-tabs>
      }
    </div>

    <!-- Footer Navigation -->
    <div class="border-t border-slate-200 p-6">
      <div class="flex justify-between">
        <!-- CREATE MODE: Previous Button -->
        @if (!isEditMode() && !isLastStep()) {
          <lfx-button
            label="Previous"
            icon="fa-light fa-arrow-left"
            [disabled]="!canGoPrevious()"
            [outlined]="true"
            (onClick)="previousStep()"
            size="small"
            data-testid="meeting-manage-previous-btn">
          </lfx-button>
        } @else {
          <!-- EDIT MODE: Empty space for alignment -->
          <div></div>
        }

        <div class="flex gap-3">
          <lfx-button
            [label]="isLastStep() ? 'Skip For Now' : 'Cancel'"
            [outlined]="true"
            (onClick)="onCancel()"
            data-testid="meeting-manage-cancel-btn"
            size="small">
          </lfx-button>

          @if (!isEditMode()) {
            <!-- CREATE MODE: Next/Create Button -->
            @if (!isLastMeetingStep() && !isLastStep()) {
              <lfx-button
                label="Next"
                icon="fa-light fa-arrow-right"
                [iconPos]="'right'"
                [disabled]="!canProceed()"
                [severity]="'primary'"
                (onClick)="nextStep()"
                size="small"
                data-testid="meeting-manage-next-btn">
              </lfx-button>
            } @else if (isLastMeetingStep()) {
              <lfx-button
                label="Create Meeting"
                icon="fa-light fa-calendar-days"
                size="small"
                [loading]="submitting()"
                [disabled]="!canProceed() || submitting()"
                severity="primary"
                (onClick)="onSubmit()"
                data-testid="meeting-manage-submit-btn">
              </lfx-button>
            } @else {
              <lfx-button
                label="Invite Guests"
                icon="fa-light fa-envelope"
                size="small"
                [loading]="submitting()"
                [disabled]="!hasRegistrantUpdates() || submitting()"
                severity="primary"
                (onClick)="onManageRegistrants()"
                data-testid="meeting-manage-submit-btn">
              </lfx-button>
            }
          } @else {
            <!-- EDIT MODE: Update Button -->
            @if (currentStep() === 1) {
              <lfx-button
                label="Update Meeting"
                icon="fa-light fa-check"
                size="small"
                [loading]="submitting()"
                [disabled]="submitting()"
                [severity]="'primary'"
                (onClick)="onSubmit()"
                data-testid="meeting-manage-update-btn">
              </lfx-button>
            } @else {
              <lfx-button
                label="Update Guests"
                icon="fa-light fa-envelope"
                size="small"
                [loading]="submitting()"
                [disabled]="!hasRegistrantUpdates() || submitting()"
                severity="primary"
                (onClick)="onManageRegistrants()"
                data-testid="meeting-manage-submit-btn">
              </lfx-button>
            }
          }
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Dialog -->
<p-confirmDialog></p-confirmDialog>
