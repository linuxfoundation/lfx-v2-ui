<!-- Copyright The Linux Foundation and each contributor to LFX. -->
<!-- SPDX-License-Identifier: MIT -->

<lfx-card>
  <!-- Filter Bar Inside Card -->
  <div class="pb-2 mb-2">
    <div class="flex flex-col md:flex-row md:items-center gap-3 md:gap-4">
      <!-- Search Input -->
      <div class="flex-1">
        <lfx-input-text
          [form]="searchForm()"
          control="search"
          placeholder="Search mailing lists..."
          icon="fa-light fa-search"
          styleClass="w-full"
          size="small"
          data-testid="mailing-list-search-input"></lfx-input-text>
      </div>

      <!-- Committee Filter Dropdown -->
      <div class="w-full sm:w-48">
        <lfx-select
          [form]="searchForm()"
          control="committee"
          size="small"
          [options]="committeeFilterOptions()"
          placeholder="Select Committee"
          [showClear]="true"
          styleClass="w-full"
          data-testid="mailing-list-committee-filter"></lfx-select>
      </div>

      <!-- Status Filter Dropdown -->
      <div class="w-full sm:w-48">
        <lfx-select
          [form]="searchForm()"
          control="status"
          size="small"
          [options]="statusFilterOptions()"
          placeholder="Select Status"
          [showClear]="true"
          styleClass="w-full"
          data-testid="mailing-list-status-filter"></lfx-select>
      </div>
    </div>
  </div>

  <lfx-table
    [value]="mailingLists()"
    [paginator]="mailingLists().length > 10"
    [rows]="10"
    [rowsPerPageOptions]="[10, 25, 50]"
    sortField="title"
    [sortOrder]="1"
    data-testid="mailing-list-dashboard-table">
    <!-- Header Template - Conditional based on isMaintainer -->
    <ng-template #header>
      <tr>
        @if (isMaintainer()) {
          <!-- Maintainer View Headers (7 columns) -->
          <th>Name</th>
          <th>List Email</th>
          <th class="min-w-[300px]">Description</th>
          <th>Visibility</th>
          <th>Posting</th>
          <th>Linked {{ committeeLabel.plural }}</th>
          <th>Subscribers</th>
        } @else {
          <!-- PMO View Headers (6 columns) -->
          <th>Mailing List</th>
          <th class="min-w-[300px]">Description</th>
          <th>Linked {{ committeeLabel.plural }}</th>
          <th>Subscribers</th>
          <th>Emails Sent</th>
          <th></th>
        }
      </tr>
    </ng-template>

    <!-- Body Template -->
    <ng-template #body let-mailingList>
      <tr [attr.data-testid]="'mailing-list-row-' + mailingList.uid">
        @if (isMaintainer()) {
          <!-- Maintainer View Row -->
          <!-- Name Column -->
          <td>
            <a
              [routerLink]="['/mailing-lists', mailingList.uid]"
              class="text-blue-600 hover:text-blue-700 hover:underline"
              [attr.data-testid]="'mailing-list-title-' + mailingList.uid">
              {{ mailingList.title }}
            </a>
          </td>

          <!-- List Email Column -->
          <td>
            <div class="flex items-center gap-1.5">
              <span class="text-xs">{{ mailingList | groupEmail }}</span>
              @if (mailingList.service?.url) {
                <a [href]="mailingList.service.url" target="_blank" rel="noopener noreferrer">
                  <i class="fa-light fa-external-link-alt !text-[9px]"></i>
                </a>
              }
            </div>
          </td>

          <!-- Description Column -->
          <td>
            <div class="line-clamp-2 text-xs">
              {{ (mailingList.description | stripHtml) || '-' }}
            </div>
          </td>

          <!-- Visibility Column -->
          <td>
            <lfx-tag [value]="mailingList.public ? 'Public' : 'Private'" [severity]="mailingList.public | mailingListVisibilitySeverity"> </lfx-tag>
          </td>

          <!-- Posting Column -->
          <td>
            <lfx-tag [value]="mailingList.type | mailingListTypeLabel" severity="info"> </lfx-tag>
          </td>

          <!-- Linked Groups Column -->
          <td>
            <div class="flex flex-wrap gap-1">
              @if (mailingList.committees?.length) {
                @for (committee of mailingList.committees | sliceLinkedGroups: maxVisibleGroups; track committee.uid) {
                  <lfx-tag [value]="committee.name" severity="info"> </lfx-tag>
                }
                @if (mailingList.committees.length > maxVisibleGroups) {
                  <span
                    class="bg-slate-100 text-slate-600 text-xs px-2 py-0.5 rounded cursor-pointer hover:bg-slate-200"
                    [pTooltip]="mailingList.committees | remainingGroupsTooltip: maxVisibleGroups"
                    tooltipPosition="top">
                    +{{ mailingList.committees.length - maxVisibleGroups }} more
                  </span>
                }
              } @else {
                <span class="text-gray-400 text-xs">-</span>
              }
            </div>
          </td>

          <!-- Subscribers Column -->
          <td>{{ mailingList.subscriber_count }}</td>
        } @else {
          <!-- PMO View Row -->
          <!-- Mailing List Column -->
          <td>
            <div class="flex flex-col gap-1">
              <a [routerLink]="['/mailing-lists', mailingList.uid]" class="text-sm font-medium text-blue-600 hover:text-blue-700 hover:underline">
                {{ mailingList.title }}
              </a>
              <span class="text-xs text-gray-500">{{ mailingList | groupEmail }}</span>
            </div>
          </td>

          <!-- Description Column -->
          <td>
            <div class="line-clamp-2 text-xs">
              {{ (mailingList.description | stripHtml) || '-' }}
            </div>
          </td>

          <!-- Linked Groups Column -->
          <td>
            <div class="flex flex-wrap gap-1">
              @if (mailingList.committees?.length) {
                @for (committee of mailingList.committees | sliceLinkedGroups: maxVisibleGroups; track committee.uid) {
                  <lfx-tag [value]="committee.name" severity="info"> </lfx-tag>
                }
                @if (mailingList.committees.length > maxVisibleGroups) {
                  <span
                    class="bg-slate-100 text-slate-600 text-xs px-2 py-0.5 rounded cursor-pointer hover:bg-slate-200"
                    [pTooltip]="mailingList.committees | remainingGroupsTooltip: maxVisibleGroups"
                    tooltipPosition="top">
                    +{{ mailingList.committees.length - maxVisibleGroups }} more
                  </span>
                }
              } @else {
                <span class="text-gray-400 text-xs">-</span>
              }
            </div>
          </td>

          <!-- Subscribers Column -->
          <td [attr.data-testid]="'mailing-list-subscribers-' + mailingList.uid">
            {{ mailingList.subscriber_count }}
          </td>

          <!-- Emails Sent Column -->
          <td>-</td>

          <!-- Actions Column -->
          <td>
            <div class="flex items-center justify-end">
              <lfx-button
                icon="fa-light fa-ellipsis-vertical"
                severity="secondary"
                size="small"
                [text]="true"
                styleClass="h-8 w-8 text-gray-500 hover:text-gray-700 hover:bg-gray-100"
                [attr.data-testid]="'mailing-list-actions-' + mailingList.uid">
              </lfx-button>
            </div>
          </td>
        }
      </tr>
    </ng-template>

    <!-- Empty Message Template -->
    <ng-template #emptymessage>
      <tr>
        <td [attr.colspan]="isMaintainer() ? 7 : 6" class="text-center py-8">
          <i class="fa-light fa-eyes text-3xl text-gray-400 mb-2"></i>
          <p class="text-sm text-gray-500">No mailing lists found</p>
        </td>
      </tr>
    </ng-template>
  </lfx-table>
</lfx-card>
