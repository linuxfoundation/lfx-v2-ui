<!-- Copyright The Linux Foundation and each contributor to LFX. -->
<!-- SPDX-License-Identifier: MIT -->

<div class="max-w-4xl mx-auto px-8" id="meeting-manage">
  <!-- Back Navigation -->
  <div class="mb-4">
    <a routerLink="/meetings" class="inline-flex items-center text-gray-500 hover:text-gray-700 transition-colors">
      <i class="fa-light fa-arrow-left mr-2"></i>
      Back to Meetings
    </a>
  </div>

  <div class="bg-white rounded-lg border border-slate-200 shadow-sm">
    <!-- Header -->
    <div class="border-b border-slate-200 p-6">
      <div class="flex items-center justify-between">
        <h1 data-testid="meeting-manage-title">
          {{ isEditMode() ? 'Edit Meeting' : 'Create Meeting' }}
        </h1>
        <div class="text-sm text-slate-500" data-testid="meeting-manage-step-indicator">Step {{ currentStep() }} of {{ totalSteps }}</div>
      </div>
    </div>

    <!-- Content -->
    <div class="p-8">
      <!-- Stepper Layout -->
      <p-stepper
        [value]="currentStep()"
        (valueChange)="goToStep($event)"
        [linear]="!isEditMode()"
        styleClass="meeting-manage-stepper"
        data-testid="meeting-manage-stepper">
        <p-step-list>
          <p-step [value]="1" data-testid="meeting-manage-step-1"></p-step>
          <p-step [value]="2" data-testid="meeting-manage-step-2"></p-step>
          <p-step [value]="3" data-testid="meeting-manage-step-3"></p-step>
          <p-step [value]="4" data-testid="meeting-manage-step-4"></p-step>
          <p-step [value]="5" data-testid="meeting-manage-step-5"></p-step>
        </p-step-list>

        <p-step-panels>
          <p-step-panel [value]="1" data-testid="meeting-manage-panel-0">
            <ng-template #content let-activateCallback="activateCallback">
              <lfx-meeting-type-selection [form]="form()"></lfx-meeting-type-selection>
            </ng-template>
          </p-step-panel>

          <p-step-panel [value]="2" data-testid="meeting-manage-panel-1">
            <ng-template #content let-activateCallback="activateCallback">
              <lfx-meeting-details [form]="form()"></lfx-meeting-details>
            </ng-template>
          </p-step-panel>

          <p-step-panel [value]="3" data-testid="meeting-manage-panel-2">
            <ng-template #content let-activateCallback="activateCallback">
              <lfx-meeting-platform-features [form]="form()"></lfx-meeting-platform-features>
            </ng-template>
          </p-step-panel>

          <p-step-panel [value]="4" data-testid="meeting-manage-panel-3">
            <ng-template #content let-activateCallback="activateCallback">
              <lfx-meeting-resources-summary
                [form]="form()"
                [meetingId]="meetingId()"
                [existingAttachments]="attachments()"
                [isEditMode]="isEditMode()"
                [deletingAttachmentId]="deletingAttachmentId()"
                [pendingAttachmentDeletions]="pendingAttachmentDeletions()"
                (goToStep)="goToStep($event)"
                (deleteAttachment)="deleteAttachment($event)"
                (undoDeleteAttachment)="undoDeleteAttachment($event)"
                (deleteLinkAttachment)="deleteLinkAttachment($event)">
              </lfx-meeting-resources-summary>
            </ng-template>
          </p-step-panel>

          <p-step-panel [value]="5" data-testid="meeting-manage-panel-4">
            <ng-template #content let-activateCallback="activateCallback">
              @if (meetingId()) {
                <lfx-meeting-registrants-manager [meetingUid]="meetingId()!" [(registrantUpdates)]="registrantUpdates" [refresh]="registrantUpdatesRefresh$">
                </lfx-meeting-registrants-manager>
              } @else {
                <div class="text-center py-8 text-gray-500">
                  <p>Meeting must be created before managing guests.</p>
                </div>
              }
            </ng-template>
          </p-step-panel>
        </p-step-panels>
      </p-stepper>
    </div>

    <!-- Footer Navigation -->
    <div class="border-t border-slate-200 p-6">
      <div class="flex justify-between">
        <!-- Previous Button -->
        @if (!isLastStep()) {
          <lfx-button
            label="Previous"
            icon="fa-light fa-arrow-left"
            [disabled]="!canGoPrevious()"
            [outlined]="true"
            (onClick)="previousStep()"
            size="small"
            data-testid="meeting-manage-previous-btn">
          </lfx-button>
        } @else {
          <!-- Empty space for alignment -->
          <div></div>
        }

        <div class="flex gap-3">
          @if (!isEditMode()) {
            <lfx-button
              [label]="isLastStep() ? 'Skip For Now' : 'Cancel'"
              [outlined]="true"
              (onClick)="onCancel()"
              data-testid="meeting-manage-cancel-btn"
              size="small">
            </lfx-button>
          }

          <!-- Next/Submit Button -->
          @if (!isLastMeetingStep() && !isLastStep()) {
            <!-- Steps 1-3: Next Button -->
            <lfx-button
              label="Next"
              icon="fa-light fa-arrow-right"
              iconPos="right"
              [disabled]="!canProceed()"
              severity="primary"
              (onClick)="nextStep()"
              size="small"
              data-testid="meeting-manage-next-btn">
            </lfx-button>
          } @else if (isLastMeetingStep() && !isEditMode()) {
            <!-- Step 4 Create Mode: Create Meeting Button -->
            <lfx-button
              label="Create Meeting"
              icon="fa-light fa-calendar-days"
              size="small"
              [loading]="submitting()"
              [disabled]="!canProceed() || submitting()"
              severity="primary"
              (onClick)="onSubmit()"
              data-testid="meeting-manage-submit-btn">
            </lfx-button>
          } @else if (isLastMeetingStep() && isEditMode()) {
            <!-- Step 4 Edit Mode: Next Button -->
            <lfx-button
              label="Next"
              icon="fa-light fa-arrow-right"
              iconPos="right"
              severity="primary"
              (onClick)="nextStep()"
              size="small"
              data-testid="meeting-manage-next-btn">
            </lfx-button>
          } @else if (isLastStep() && !isEditMode()) {
            <!-- Step 5 Create Mode: Invite Guests Button -->
            <lfx-button
              label="Invite Guests"
              icon="fa-light fa-envelope"
              size="small"
              [loading]="submitting()"
              [disabled]="!hasRegistrantUpdates() || submitting()"
              severity="primary"
              (onClick)="onManageRegistrants()"
              data-testid="meeting-manage-submit-btn">
            </lfx-button>
          } @else {
            <!-- Step 5 Edit Mode: Update Meeting Button -->
            <lfx-button
              label="Update Meeting"
              icon="fa-light fa-check"
              size="small"
              [loading]="submitting()"
              [disabled]="submitting()"
              severity="primary"
              (onClick)="onSubmitAll()"
              data-testid="meeting-manage-update-btn">
            </lfx-button>
          }
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Dialog -->
<p-confirmDialog></p-confirmDialog>
