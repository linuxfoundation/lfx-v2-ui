<!-- Copyright The Linux Foundation and each contributor to LFX. -->
<!-- SPDX-License-Identifier: MIT -->

<div class="pb-4">
  <!-- Step Title -->
  <div class="mb-6">
    <h2 class="font-normal">Meeting Details</h2>
    <p class="text-sm text-gray-500 mt-1">Set the date, time, and schedule to help participants plan and prepare effectively</p>
  </div>

  <!-- Two Column Layout -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
    <!-- Left Column - Title, Agenda -->
    <div class="flex flex-col gap-4">
      <!-- Meeting Title (Required) -->
      <div>
        <label for="meeting-title" class="block text-neutral-950 mb-2"> Meeting Title <span class="text-red-500">*</span> </label>
        <lfx-input-text
          [form]="form()"
          size="small"
          control="title"
          id="meeting-title"
          placeholder="Enter meeting title"
          styleClass="w-full"
          data-testid="meeting-details-title-input"></lfx-input-text>
        @if (titleWasAutoGenerated()) {
          <p class="mt-1 text-xs text-gray-500">This title was auto-generated based on your meeting type and date. You can customize it.</p>
        }
        @if (form().get('title')?.errors?.['required'] && form().get('title')?.touched) {
          <p class="mt-1 text-sm text-red-600">Meeting title is required</p>
        }
      </div>

      <!-- Agenda (Required) -->
      <div>
        <div class="flex items-center justify-between mb-2">
          <label for="meeting-agenda" class="block text-neutral-950"> Agenda <span class="text-red-500">*</span> </label>
          @if (!showAiHelper() && !showTemplateSelector()) {
            <div class="flex items-center gap-3">
              <button
                type="button"
                (click)="showAgendaTemplateSelector()"
                class="flex items-center gap-1.5 text-sm text-gray-600 hover:text-gray-900"
                data-testid="meeting-details-template-button">
                <i class="fa-light fa-file-lines text-sm"></i>
                Use Template
              </button>
              <button
                type="button"
                (click)="showAiAgendaHelper()"
                class="flex items-center gap-1.5 text-sm text-blue-500 hover:text-blue-600"
                data-testid="meeting-details-ai-helper-button">
                <i class="fa-light fa-sparkles text-sm"></i>
                Help me write this
              </button>
            </div>
          }
        </div>

        @if (showAiHelper()) {
          <div class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-violet-50 border border-blue-200 rounded-lg">
            <div class="flex items-start gap-3 mb-3">
              <div class="bg-gradient-to-r flex items-center justify-center from-blue-500 to-violet-600 p-1.5 rounded-full">
                <i class="fa-light fa-sparkles text-white text-sm"></i>
              </div>
              <div>
                <h4 class="text-sm font-semibold text-gray-900 mb-1">AI Agenda Generator</h4>
                <p class="text-sm text-gray-600">Tell me what you want to accomplish in this meeting, and I'll create a structured agenda for you.</p>
              </div>
            </div>

            <div class="flex flex-col gap-3">
              <lfx-textarea
                [form]="form()"
                control="aiPrompt"
                placeholder="Example: 'Discuss the new authentication system implementation, review security concerns, and plan the rollout timeline for our open source project'"
                [rows]="4"
                styleClass="w-full min-h-20 text-sm border-gray-200 focus:border-blue-500 focus:ring-blue-500 bg-white"
                data-testid="meeting-details-ai-prompt"></lfx-textarea>

              <div class="flex items-center gap-2">
                <lfx-button
                  (onClick)="generateAiAgenda()"
                  [disabled]="!form().get('aiPrompt')?.value?.trim() || isGeneratingAgenda()"
                  [loading]="isGeneratingAgenda()"
                  icon="fa-light fa-sparkles"
                  label="Generate Agenda"
                  styleClass="bg-gradient-to-r from-blue-500 to-violet-600 hover:from-blue-600 hover:to-violet-700 text-white text-sm h-8"
                  data-testid="meeting-details-generate-agenda"></lfx-button>

                <lfx-button
                  (onClick)="hideAiAgendaHelper()"
                  label="Cancel"
                  [text]="true"
                  styleClass="text-gray-500 hover:text-gray-700 text-sm h-8"
                  data-testid="meeting-details-cancel-ai"></lfx-button>
              </div>
            </div>
          </div>
        }

        @if (showTemplateSelector()) {
          <lfx-agenda-template-selector
            [meetingType]="form().get('meeting_type')?.value"
            [visible]="showTemplateSelector()"
            (templateSelected)="applyTemplate($event)"
            (closeSelector)="hideAgendaTemplateSelector()"
            data-testid="meeting-details-template-selector">
          </lfx-agenda-template-selector>
        }

        <lfx-textarea
          [form]="form()"
          control="description"
          id="meeting-agenda"
          placeholder="Enter meeting agenda and key discussion points"
          styleClass="w-full min-h-48"
          [rows]="8"
          [maxlength]="2000"
          data-testid="meeting-details-agenda-textarea"></lfx-textarea>
        <div class="flex items-center justify-between mt-2">
          <p class="text-sm text-gray-600">A clear agenda helps guests prepare and keeps discussions focused</p>
          <p
            class="text-xs"
            [ngClass]="{
              'text-gray-500': (form().get('description')?.value?.length || 0) < 1800,
              'text-amber-600': (form().get('description')?.value?.length || 0) >= 1800 && (form().get('description')?.value?.length || 0) < 2000,
              'text-red-600': (form().get('description')?.value?.length || 0) >= 2000,
            }">
            {{ form().get('description')?.value?.length || 0 }}/2000
          </p>
        </div>
        @if (form().get('description')?.errors?.['required'] && form().get('description')?.touched) {
          <p class="mt-1 text-sm text-red-600">Meeting agenda is required</p>
        }
        @if (form().get('description')?.errors?.['maxlength'] && form().get('description')?.touched) {
          <p class="mt-1 text-sm text-red-600">Meeting agenda cannot exceed 2000 characters</p>
        }
      </div>
    </div>

    <!-- Right Column - Date & Time, Recurring -->
    <div class="flex flex-col gap-4">
      <!-- Start Date -->
      <div>
        <label for="start-date" class="block text-neutral-950 mb-2"> Start Date <span class="text-red-500">*</span> </label>
        <lfx-calendar
          [form]="form()"
          control="startDate"
          appendTo="body"
          id="start-date"
          placeholder="Select date"
          [minDate]="minDate()"
          class="w-full"
          styleClass="w-full"
          data-testid="meeting-details-start-date"></lfx-calendar>
        @if (form().get('startDate')?.errors?.['required'] && form().get('startDate')?.touched) {
          <p class="mt-1 text-sm text-red-600">Start date is required</p>
        }
      </div>

      <!-- Start Time -->
      <div>
        <label for="start-time" class="block text-neutral-950 mb-2"> Start Time <span class="text-red-500">*</span> </label>
        <lfx-time-picker
          [form]="form()"
          control="startTime"
          id="start-time"
          placeholder="Select time"
          styleClass="w-full"
          data-testid="meeting-details-start-time"></lfx-time-picker>
        @if (form().get('startTime')?.errors?.['required'] && form().get('startTime')?.touched) {
          <p class="mt-1 text-sm text-red-600">Start time is required</p>
        }
      </div>

      <!-- Duration -->
      <div>
        <label for="duration" class="block text-neutral-950 mb-2"> Duration <span class="text-red-500">*</span> </label>
        <lfx-select
          [form]="form()"
          control="duration"
          [options]="durationOptions"
          placeholder="Select duration"
          styleClass="w-full"
          id="duration"
          data-testid="meeting-details-duration-select"></lfx-select>
        @if (form().get('duration')?.errors?.['required'] && form().get('duration')?.touched) {
          <p class="mt-1 text-sm text-red-600">Duration is required</p>
        }
      </div>

      <!-- Custom Duration (shown when 'custom' is selected) -->
      @if (form().get('duration')?.value === 'custom') {
        <div>
          <label for="custom-duration" class="block text-neutral-950 mb-2"> Custom Duration (minutes) <span class="text-red-500">*</span> </label>
          <lfx-input-text
            [form]="form()"
            control="customDuration"
            id="custom-duration"
            placeholder="Enter minutes (5-480)"
            type="number"
            styleClass="w-full"
            data-testid="meeting-details-custom-duration"></lfx-input-text>
          @if (form().get('customDuration')?.errors?.['required'] && form().get('customDuration')?.touched) {
            <p class="mt-1 text-sm text-red-600">Custom duration is required</p>
          }
          @if (form().get('customDuration')?.errors?.['min'] && form().get('customDuration')?.touched) {
            <p class="mt-1 text-sm text-red-600">Custom duration must be at least 5 minutes</p>
          }
          @if (form().get('customDuration')?.errors?.['max'] && form().get('customDuration')?.touched) {
            <p class="mt-1 text-sm text-red-600">Custom duration cannot exceed 480 minutes (8 hours)</p>
          }
        </div>
      }

      <!-- Timezone -->
      <div>
        <label for="timezone" class="block text-neutral-950 mb-2"> Timezone <span class="text-red-500">*</span> </label>
        <lfx-select
          [filter]="true"
          [form]="form()"
          control="timezone"
          [options]="timezoneOptions"
          placeholder="Select timezone"
          styleClass="w-full"
          id="timezone"
          data-testid="meeting-details-timezone-select"></lfx-select>
        @if (form().get('timezone')?.errors?.['required'] && form().get('timezone')?.touched) {
          <p class="mt-1 text-sm text-red-600">Timezone is required</p>
        }
      </div>

      <!-- Early Join Time -->
      <div>
        <label for="early-join-time" class="flex items-center gap-2 text-neutral-950 mb-2">
          Early Join Time (minutes before start)
          <i
            class="fa-light fa-info-circle text-gray-400 cursor-help"
            pTooltip="Allow guests to join the meeting early. Useful for informal networking before the official start time"
            tooltipPosition="right"
            tooltipStyleClass="text-xs max-w-xs"></i>
        </label>
        <lfx-input-text
          [form]="form()"
          control="early_join_time_minutes"
          size="small"
          id="early-join-time"
          placeholder="10"
          type="number"
          styleClass="w-full"
          data-testid="meeting-details-early-join"></lfx-input-text>
        @if (form().get('early_join_time_minutes')?.errors?.['min'] && form().get('early_join_time_minutes')?.touched) {
          <p class="mt-1 text-sm text-red-600">Early join time must be at least 10 minutes</p>
        }
        @if (form().get('early_join_time_minutes')?.errors?.['max'] && form().get('early_join_time_minutes')?.touched) {
          <p class="mt-1 text-sm text-red-600">Early join time cannot exceed 60 minutes</p>
        }
      </div>

      <!-- Future Date/Time validation error -->
      @if (form().errors?.['futureDateTime'] && (form().get('startDate')?.touched || form().get('startTime')?.touched)) {
        <p class="text-sm text-red-600">Meeting must be scheduled in the future</p>
      }

      <!-- Recurring Meeting Toggle -->
      <lfx-feature-toggle [feature]="recurringFeature" [form]="form()">
        @if (form().get('isRecurring')?.value) {
          <div class="mt-4 pt-4 border-t border-gray-200">
            <label for="recurrence" class="block text-neutral-950 mb-2">Cadence <span class="text-red-500">*</span></label>
            <div class="flex flex-col gap-2">
              <lfx-select
                [form]="form()"
                appendTo="body"
                control="recurrenceType"
                [options]="recurrenceOptions()"
                placeholder="Select recurrence"
                styleClass="w-full"
                id="recurrence"
                data-testid="meeting-details-recurrence-select"></lfx-select>
              <!-- Custom Recurrence Pattern Component -->
              @if (showCustomRecurrence()) {
                <lfx-meeting-recurrence-pattern [form]="form()" data-testid="meeting-details-custom-recurrence"> </lfx-meeting-recurrence-pattern>
              }
            </div>
          </div>
        }
      </lfx-feature-toggle>
    </div>
  </div>
</div>
