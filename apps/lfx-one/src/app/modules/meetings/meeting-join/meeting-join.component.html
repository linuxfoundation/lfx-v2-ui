<!-- Copyright The Linux Foundation and each contributor to LFX. -->
<!-- SPDX-License-Identifier: MIT -->
<lfx-header></lfx-header>

@if (meeting()) {
  <div class="bg-gray-50 min-h-screen">
    <!-- Main Content Container -->
    <div class="container mx-auto py-6 px-8">
      <div class="max-w-[900px] mx-auto flex flex-col">
        <!-- Project Logo -->
        @if (project()?.logo_url) {
          <div class="flex items-center justify-center mb-6">
            <img [src]="project()?.logo_url" [alt]="project()?.name" class="w-auto h-10 md:h-14" />
          </div>
        }

        <!-- Main Meeting Card -->
        <lfx-card class="rounded-[12.75px] mb-6" [attr.data-testid]="'meeting-info-card'">
          <!-- Header Section: Badges + Copy Link -->
          <div class="flex justify-between items-start mb-4">
            <!-- Left: Badges -->
            <div class="flex items-center gap-2 flex-wrap">
              <!-- Private Badge -->
              @if (meeting().visibility === 'private') {
                <lfx-tag value="Private" severity="danger" icon="fa-light fa-shield" [attr.data-testid]="'meeting-badge-private'"></lfx-tag>
              }

              <!-- Meeting Type Badge -->
              @if (meetingTypeBadge(); as badge) {
                <lfx-tag [value]="badge.text" [severity]="badge.severity" [icon]="badge.icon" [attr.data-testid]="'meeting-badge-type'"></lfx-tag>
              }

              <!-- Recurring Badge -->
              @if (meeting().recurrence) {
                <lfx-tag
                  [value]="meeting().recurrence | recurrenceSummary"
                  severity="secondary"
                  icon="fa-light fa-repeat"
                  pTooltip="This is a recurring meeting"
                  data-testid="recurring-badge"></lfx-tag>
              }
            </div>

            <!-- Right: Copy Link Button -->
            <lfx-button
              [icon]="'fa-light fa-copy'"
              [rounded]="true"
              size="small"
              severity="secondary"
              [text]="true"
              (onClick)="handleCopyLink()"
              [attr.data-testid]="'meeting-copy-link-button'"
              [pTooltip]="'Copy meeting link'">
            </lfx-button>
          </div>

          <!-- Content Row: Title/Details + Join Button (if immediate) -->
          <div class="flex flex-col md:flex-row justify-between items-start gap-6 mb-4">
            <!-- Left Column: Title + Details -->
            <div class="flex-1 flex flex-col gap-4 justify-between h-full">
              <div class="flex flex-col gap-4 h-full">
                <!-- Meeting Title -->
                <h1 [attr.data-testid]="'meeting-title'">
                  {{ meetingTitle() }}
                </h1>

                <!-- Feature Badges Row -->
                <div class="flex flex-wrap gap-2 items-center">
                  <!-- Date/Time Badge -->
                  @if (currentOccurrence()?.start_time || meeting().start_time; as startTime) {
                    <lfx-tag
                      [value]="startTime | meetingTime: currentOccurrence()?.duration || meeting().duration : 'compact'"
                      severity="secondary"
                      icon="fa-light fa-calendar-days"
                      [attr.data-testid]="'meeting-badge-datetime'"></lfx-tag>
                  }

                  <!-- YouTube Upload Badge -->
                  @if (meeting().youtube_upload_enabled) {
                    <lfx-tag value="YouTube Upload" severity="danger" icon="fa-light fa-upload" [attr.data-testid]="'meeting-badge-youtube'"></lfx-tag>
                  }

                  <!-- Recording Badge -->
                  @if (meeting().recording_enabled) {
                    <lfx-tag value="Recording" severity="info" icon="fa-light fa-video" [attr.data-testid]="'meeting-badge-recording'"></lfx-tag>
                  }

                  <!-- Transcripts Badge -->
                  @if (meeting().transcript_enabled) {
                    <lfx-tag value="Transcripts" severity="secondary" icon="fa-light fa-file-lines" [attr.data-testid]="'meeting-badge-transcripts'"></lfx-tag>
                  }

                  <!-- AI Summary Badge -->
                  @if (hasAiCompanion()) {
                    <lfx-tag value="AI Summary" severity="success" icon="fa-light fa-sparkles" [attr.data-testid]="'meeting-badge-live-chat'"></lfx-tag>
                  }
                </div>
              </div>
              <!-- Alert Banner -->
              @if (messageSeverity() === 'warn') {
                <div class="bg-amber-50 border border-amber-500/50 rounded px-3 py-2 flex items-center gap-2" [attr.data-testid]="'meeting-alert-warn'">
                  <i class="fa-light fa-clock text-amber-500 text-base"></i>
                  <p class="text-sm text-amber-900">{{ alertMessage() }}</p>
                </div>
              } @else if (messageSeverity() === 'info' && canJoinMeeting()) {
                <div class="bg-blue-50 border border-blue-500/50 rounded px-3 py-2 flex items-center gap-2" [attr.data-testid]="'meeting-alert-info'">
                  <i class="fa-light fa-calendar text-blue-500 text-base"></i>
                  <p class="text-sm text-blue-900">{{ alertMessage() }}</p>
                </div>
              }
            </div>

            <!-- Right Column: Join Button (immediate meetings) or RSVP (future meetings) -->
            @if (canJoinMeeting() && authenticated()) {
              @if (fetchedJoinUrl() && !showGuestForm()) {
                <div class="w-full md:w-[296px]">
                  <lfx-button
                    class="w-full h-[40px]"
                    styleClass="w-full"
                    label="Join Meeting"
                    icon="fa-light fa-video"
                    severity="success"
                    size="large"
                    [href]="fetchedJoinUrl()"
                    target="_blank"
                    rel="noopener noreferrer"
                    [attr.data-testid]="'join-meeting-button-immediate'">
                  </lfx-button>
                </div>
              } @else if (joinUrlError() !== null && !showGuestForm()) {
                <div class="w-full md:w-[296px] flex flex-col gap-2">
                  <lfx-button
                    label="Join Meeting"
                    icon="fa-light fa-video"
                    [disabled]="true"
                    size="large"
                    styleClass="w-full h-[40px] bg-gray-300 text-gray-500 border-none cursor-not-allowed"
                    rel="noopener noreferrer"
                    [attr.data-testid]="'join-meeting-button-error'">
                  </lfx-button>
                  <div class="text-xs text-red-500 bg-red-50 border border-red-500/50 rounded px-3 py-2">
                    <span>{{ joinUrlError() }}</span
                    >.
                    @if (emailError()) {
                      <span><a class="text-primary cursor-pointer" (click)="onEmailErrorClick()">Click here</a> to join using a different email address.</span>
                    }
                  </div>
                </div>
              }
            } @else if (authenticated() && meeting().organizer && !isLegacyMeeting()) {
              <!-- RSVP Details - Future Meeting (Authenticated Organizers) -->
              <div class="w-full md:w-[296px] flex flex-col gap-3">
                <lfx-meeting-rsvp-details
                  [meeting]="meeting()"
                  [project]="project()"
                  [currentOccurrence]="currentOccurrence()"
                  [pastMeeting]="false"
                  [showAddButton]="true"
                  [additionalRegistrantsCount]="0"
                  backgroundColor="bg-slate-50"
                  borderColor="border-slate-200">
                </lfx-meeting-rsvp-details>

                <!-- View Guests Button -->
                <lfx-button
                  class="w-full"
                  styleClass="w-full"
                  label="View Guests"
                  icon="fa-light fa-users"
                  [outlined]="true"
                  severity="secondary"
                  size="small"
                  (onClick)="onRegistrantsToggle()"
                  data-testid="view-guests-button">
                </lfx-button>
              </div>
            } @else if (authenticated() && !isLegacyMeeting()) {
              <!-- RSVP Container - Future Meeting (Authenticated Non-Organizers) -->
              <div class="w-full md:w-[296px]">
                @if (isInvited()) {
                  @defer (when meeting()) {
                    <lfx-rsvp-button-group [meeting]="meeting()" [occurrenceId]="currentOccurrence()?.occurrence_id"> </lfx-rsvp-button-group>
                  }
                } @else if (canRegisterForMeeting()) {
                  <lfx-button
                    class="w-full"
                    styleClass="w-full"
                    icon="fa-light fa-user-plus"
                    label="Register for Meeting"
                    size="small"
                    severity="secondary"
                    (onClick)="registerForMeeting()"
                    data-testid="register-meeting-button">
                  </lfx-button>
                }
              </div>
            }
          </div>

          <!-- Meeting Registrants -->
          <lfx-meeting-registrants-display [meeting]="meeting()" [pastMeeting]="false" [showAddRegistrant]="false" [visible]="showRegistrants()">
          </lfx-meeting-registrants-display>

          <!-- Divider -->
          <hr class="border-gray-200 my-4" />

          <!-- Agenda + Resources Row (2-column) -->
          <div class="flex flex-col md:flex-row gap-6">
            <!-- Left: Agenda Section (flex-1) -->
            <div class="flex-1 flex flex-col gap-2">
              <!-- Agenda Header -->
              <div class="flex items-center gap-2">
                <i class="fa-light fa-list text-gray-500 text-xs"></i>
                <h3 class="text-gray-600 text-sm font-normal">Agenda</h3>
              </div>

              <!-- Description -->
              @if (meetingDescription(); as description) {
                <div class="text-gray-600 text-xs leading-relaxed" [attr.data-testid]="'meeting-description'">
                  <lfx-expandable-text [maxHeight]="200">
                    <div [innerHTML]="description | linkify" class="text-sm leading-relaxed"></div>
                  </lfx-expandable-text>
                </div>
              }
            </div>

            <!-- Right: Resources Card (fixed width) -->
            <div class="w-full md:w-[296px]">
              <div class="bg-slate-50 border border-slate-200 rounded-md p-3" [attr.data-testid]="'resources-card'">
                <!-- Resources Header -->
                <div class="flex items-center gap-2 mb-2">
                  <i class="fa-light fa-paperclip text-gray-500 text-xs"></i>
                  <h3 class="text-gray-600 text-sm font-normal">Resources</h3>
                </div>

                <!-- Attachments List -->
                @if (attachments().length > 0) {
                  <div class="flex flex-col gap-2">
                    @for (attachment of attachments(); track attachment.uid; let i = $index) {
                      <a
                        [href]="attachment.type === 'link' ? attachment.link : '/api/meetings/' + meeting().uid + '/attachments/' + attachment.uid"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="bg-gray-200 hover:bg-gray-300 rounded px-3 py-2 flex items-center gap-3 min-w-[180px] transition-colors cursor-pointer"
                        [attr.data-testid]="'meeting-attachment-' + i">
                        <!-- Icon - File or Link -->
                        @if (attachment.type === 'link') {
                          <i class="fa-light fa-arrow-up-right-from-square text-3xl text-black w-8 flex-shrink-0"></i>
                        } @else {
                          <i [class]="(attachment.mime_type || '' | fileTypeIcon) + ' text-3xl text-black w-8 flex-shrink-0'"></i>
                        }

                        <!-- Attachment Name -->
                        <span class="text-sm text-gray-950 overflow-ellipsis overflow-hidden whitespace-nowrap flex-1 font-sans">{{ attachment.name }}</span>
                      </a>
                    }
                  </div>
                } @else {
                  @if (!authenticated() && meeting().visibility === 'private') {
                    <p class="text-sm text-gray-500 italic">If you have been invited to this meeting, resources may be available when you sign in.</p>
                  } @else {
                    <p class="text-sm text-gray-500 italic">No resources available</p>
                  }
                }
              </div>
            </div>
          </div>

          <!-- Footer Divider -->
          <hr class="border-gray-200 my-4" />

          <!-- Card Footer: Authentication Section -->
          @if (authenticated() && user(); as user) {
            <!-- Signed In State -->
            <div class="flex flex-col gap-6">
              <div class="flex flex-col gap-3">
                <p class="text-sm text-gray-950">You are signed in as:</p>

                <div class="bg-blue-50 border border-blue-500/50 rounded px-3 py-2 flex flex-wrap items-center gap-3">
                  <!-- Avatar -->
                  <div class="hidden md:flex w-12 h-12 bg-blue-600 rounded-full items-center justify-center">
                    <span class="text-white text-2xl font-medium">{{ (user.name || 'User').substring(0, 2).toUpperCase() }}</span>
                  </div>

                  <!-- User Info -->
                  <div class="flex-1">
                    <p class="font-semibold text-sm text-blue-900">{{ user.name }}</p>
                    <p class="text-sm text-blue-900">{{ user.email }}</p>
                  </div>
                </div>
              </div>

              <!-- Guest Form for authenticated users -->
              @if (showGuestForm()) {
                <!-- OR Divider -->
                <div class="relative h-px bg-gray-200">
                  <span class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 bg-white px-3 text-xs text-gray-600">OR</span>
                </div>

                <lfx-guest-form [form]="joinForm" [joinUrl]="fetchedJoinUrl()" [isLoading]="isLoadingJoinUrl()"> </lfx-guest-form>
                @if (joinUrlError() !== null) {
                  <div class="text-xs text-red-500 bg-red-50 border border-red-500/50 rounded px-3 py-2 text-center">
                    <span>{{ joinUrlError() }}. Please contact the meeting organizer or support team if you believe this is an error.</span>
                  </div>
                }
              }
            </div>
          } @else {
            <!-- Signed Out State -->
            <div class="flex flex-col gap-6">
              <!-- Sign In CTA -->
              <div class="bg-blue-50 border border-blue-500/50 rounded px-3 py-2 flex flex-wrap items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                  <i class="fa-light fa-arrow-right-to-bracket text-blue-600 text-2xl"></i>
                  <div>
                    <p class="font-semibold text-sm text-blue-900">Sign in with your LFX account</p>
                    <p class="text-xs text-gray-600">Join quickly with your saved information</p>
                  </div>
                </div>

                <lfx-button
                  class="w-full md:w-auto"
                  styleClass="w-full md:w-auto"
                  size="small"
                  label="Sign In"
                  icon="fa-light fa-arrow-right-to-bracket"
                  severity="info"
                  [href]="'/login?returnTo=' + returnTo()">
                </lfx-button>
              </div>

              <!-- OR Divider -->
              <div class="relative h-px bg-gray-200">
                <span class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 bg-white px-3 text-xs text-gray-600">OR</span>
              </div>

              <!-- Guest Form -->
              <lfx-guest-form [form]="joinForm" [joinUrl]="fetchedJoinUrl()" [isLoading]="isLoadingJoinUrl()"> </lfx-guest-form>
              @if (joinUrlError() !== null) {
                <div class="text-xs text-red-500 bg-red-50 border border-red-500/50 rounded px-3 py-2 text-center">
                  <span>{{ joinUrlError() }}. Please contact the meeting organizer or support team if you believe this is an error.</span>
                </div>
              }
            </div>
          }
        </lfx-card>
      </div>
    </div>

    <!-- Toast Notifications -->
    <p-toast></p-toast>
  </div>
}
