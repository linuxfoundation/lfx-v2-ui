<!-- Copyright The Linux Foundation and each contributor to LFX. -->
<!-- SPDX-License-Identifier: MIT -->

<section data-testid="foundation-health-section">
  <div class="flex flex-wrap gap-3 items-end justify-between mb-4">
    <div class="flex flex-col gap-3">
      <div class="flex gap-3 flex-wrap">
        <h2 class="mb-0">{{ title() }}</h2>
        <!-- Data Copilot Button -->
        <lfx-data-copilot [includeOrganizationId]="false" [includeOrganizationName]="false"></lfx-data-copilot>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <!-- Filter Pills -->
        <lfx-filter-pills
          [options]="filterOptions"
          [selectedFilter]="selectedFilter()"
          (filterChange)="handleFilterChange($event)"
          data-testid="foundation-health-filters"></lfx-filter-pills>
      </div>
    </div>

    <!-- Carousel Controls -->
    <div class="flex items-center gap-2">
      <button
        type="button"
        (click)="scrollShadowDirective.scrollLeft()"
        class="h-8 w-8 p-0 flex items-center justify-center rounded border border-gray-300 bg-white text-gray-600 hover:bg-gray-100 hover:border-gray-400 transition-colors"
        data-testid="foundation-health-carousel-prev"
        aria-label="Scroll left">
        <i class="fa-light fa-chevron-left"></i>
      </button>
      <button
        type="button"
        (click)="scrollShadowDirective.scrollRight()"
        class="h-8 w-8 p-0 flex items-center justify-center rounded border border-gray-300 bg-white text-gray-600 hover:bg-gray-100 hover:border-gray-400 transition-colors"
        data-testid="foundation-health-carousel-next"
        aria-label="Scroll right">
        <i class="fa-light fa-chevron-right"></i>
      </button>
    </div>
  </div>

  @if (!hasFoundationSelected()) {
    <!-- No Foundation Selected State -->
    <div class="flex items-center justify-center p-12">
      <div class="text-center flex flex-col gap-3">
        <i class="fa-light fa-circle-exclamation text-4xl text-gray-400"></i>
        <p class="text-sm text-gray-600 font-medium">Please select a foundation project to view foundation health data</p>
        <p class="text-xs text-gray-500">Use the project selector in the sidebar to choose a foundation</p>
      </div>
    </div>
  } @else {
    <!-- Carousel Container -->
    <div class="relative overflow-hidden">
      <div lfxScrollShadow [scrollDistance]="320" class="flex gap-4 overflow-x-auto hide-scrollbar scroll-smooth" data-testid="foundation-health-carousel">
        @for (card of metricCards(); track card.testId) {
          @switch (card.customContentType) {
            <!-- Bar Chart - Use shared metric card -->
            @case ('bar-chart') {
              <lfx-metric-card
                [title]="card.title"
                [icon]="card.icon"
                [testId]="card.testId"
                [chartType]="card.chartType"
                [chartData]="card.chartData"
                [chartOptions]="barChartOptions"
                [value]="card.value"
                [subtitle]="card.subtitle"
                [loading]="card.loading"></lfx-metric-card>
            }

            <!-- Top Projects List - Custom content -->
            @case ('top-projects') {
              <lfx-metric-card
                [title]="card.title"
                [icon]="card.icon"
                [testId]="card.testId"
                [chartType]="card.chartType"
                [value]="card.value"
                [subtitle]="card.subtitle"
                [loading]="card.loading">
                <ng-template #customContent>
                  @if (card.topProjects) {
                    <div class="flex flex-col gap-0.5 p-0 pl-[60px] m-0 mb-[5px]">
                      <div class="text-xs font-medium text-gray-500">Top 3 Projects by Value</div>
                      @for (project of card.topProjects; track project.name) {
                        <div class="flex items-center justify-between text-sm">
                          <span class="text-gray-500">{{ project.name }}</span>
                          <span class="font-medium">{{ project.formattedValue }}</span>
                        </div>
                      }
                    </div>
                  }
                </ng-template>
              </lfx-metric-card>
            }

            <!-- Company Bus Factor - Custom content -->
            @case ('bus-factor') {
              <lfx-metric-card
                [title]="card.title"
                [icon]="card.icon"
                [testId]="card.testId"
                [chartType]="card.chartType"
                [value]="card.value"
                [subtitle]="card.subtitle"
                [loading]="card.loading">
                <ng-template #customContent>
                  @if (card.busFactor) {
                    <div class="flex-1 flex flex-col justify-end pb-2">
                      <div class="flex gap-0">
                        <div [style.width.%]="card.busFactor.topCompaniesPercentage" class="flex flex-col gap-1">
                          <div class="text-xs font-medium text-gray-700">
                            {{ card.busFactor.topCompaniesCount }} Companies ({{ card.busFactor.topCompaniesPercentage }}%)
                          </div>
                          <div class="h-4 rounded-l-sm bg-blue-500"></div>
                        </div>
                        <div [style.width.%]="card.busFactor.otherCompaniesPercentage" class="flex flex-col gap-1">
                          <div class="text-xs text-gray-600 text-right">{{ card.busFactor.otherCompaniesCount }} Other Companies</div>
                          <div class="h-4 bg-blue-200 rounded-r-sm"></div>
                        </div>
                      </div>
                    </div>
                  }
                </ng-template>
              </lfx-metric-card>
            }

            <!-- Project Health Scores - Custom content -->
            @case ('health-scores') {
              <lfx-metric-card
                [title]="card.title"
                [icon]="card.icon"
                [testId]="card.testId"
                [chartType]="card.chartType"
                [value]="card.value"
                [subtitle]="card.subtitle"
                [loading]="card.loading">
                <ng-template #customContent>
                  @if (card.healthScores) {
                    <div class="flex-1 flex flex-col justify-end p-0">
                      <div class="flex items-end justify-between gap-2 h-16">
                        @for (item of healthScoreDistribution(); track item.category) {
                          <div class="flex-1 flex flex-col items-center gap-1">
                            <div
                              class="w-full rounded-t transition-all hover:opacity-80"
                              [style.backgroundColor]="item.color"
                              [style.height.px]="item.heightPx"></div>
                            <div class="text-[10px] text-center whitespace-nowrap">
                              <div class="font-medium">{{ item.category }}</div>
                              <div class="text-gray-500">{{ item.count }}</div>
                            </div>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </ng-template>
              </lfx-metric-card>
            }

            <!-- Default fallback -->
            @default {
              <lfx-metric-card
                [title]="card.title"
                [icon]="card.icon"
                [testId]="card.testId"
                [chartType]="card.chartType"
                [chartData]="card.chartData"
                [chartOptions]="card.chartOptions"
                [value]="card.value"
                [subtitle]="card.subtitle"
                [loading]="card.loading"></lfx-metric-card>
            }
          }
        }
      </div>

      <!-- Right shadow fade -->
      @if (scrollShadowDirective && scrollShadowDirective.showRightShadow()) {
        <div
          class="absolute top-0 bottom-0 right-0 w-32 z-10 pointer-events-none bg-[linear-gradient(to_right,transparent,#f9fafb)]"
          data-testid="foundation-health-shadow-right"></div>
      }

      <!-- Left shadow fade -->
      @if (scrollShadowDirective && scrollShadowDirective.showLeftShadow()) {
        <div
          class="absolute top-0 bottom-0 left-0 w-32 z-10 pointer-events-none bg-[linear-gradient(to_left,transparent,#f9fafb)]"
          data-testid="foundation-health-shadow-left"></div>
      }
    </div>
  }
</section>
