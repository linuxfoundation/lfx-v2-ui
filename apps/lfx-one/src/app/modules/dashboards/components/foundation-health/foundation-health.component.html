<!-- Copyright The Linux Foundation and each contributor to LFX. -->
<!-- SPDX-License-Identifier: MIT -->

<section data-testid="foundation-health-section">
  <div class="flex items-center justify-between mb-4">
    <div class="flex flex-col md:flex-row md:items-center gap-3">
      <h2>{{ title() }}</h2>

      <!-- Filter Pills -->
      <lfx-filter-pills
        [options]="filterOptions"
        [selectedFilter]="selectedFilter()"
        (filterChange)="handleFilterChange($event)"
        data-testid="foundation-health-filters"></lfx-filter-pills>
    </div>

    <!-- Carousel Controls -->
    <div class="flex items-center gap-2">
      <button
        type="button"
        (click)="scrollLeft()"
        class="h-8 w-8 p-0 flex items-center justify-center rounded border border-gray-300 bg-white text-gray-600 hover:bg-gray-100 hover:border-gray-400 transition-colors"
        data-testid="foundation-health-carousel-prev"
        aria-label="Scroll left">
        <i class="fa-light fa-chevron-left"></i>
      </button>
      <button
        type="button"
        (click)="scrollRight()"
        class="h-8 w-8 p-0 flex items-center justify-center rounded border border-gray-300 bg-white text-gray-600 hover:bg-gray-100 hover:border-gray-400 transition-colors"
        data-testid="foundation-health-carousel-next"
        aria-label="Scroll right">
        <i class="fa-light fa-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- Carousel Container -->
  <div class="relative overflow-hidden">
    <!-- Left Fade Gradient -->
    @if (canScrollLeft()) {
      <div class="hidden md:block absolute top-0 bottom-0 left-0 w-24 pointer-events-none z-10" style="background: linear-gradient(to right, #f8f8f9 0%, transparent 100%);"></div>
    }
    
    <!-- Right Fade Gradient -->
    @if (canScrollRight()) {
      <div class="hidden md:block absolute top-0 bottom-0 right-0 w-24 pointer-events-none z-10" style="background: linear-gradient(to left, #f8f8f9 0%, transparent 100%);"></div>
    }
    
    <div #carouselScroll class="flex gap-4 overflow-x-auto pb-2 hide-scrollbar scroll-smooth" data-testid="foundation-health-carousel" (scroll)="onScroll()">
      @for (card of metricCards(); track card.title) {
        <div class="p-4 bg-white rounded-lg flex-shrink-0 w-[calc(100vw-3rem)] md:w-80 shadow-[0px_1px_2px_-1px_rgba(0,0,0,0.10),0px_1px_3px_0px_rgba(0,0,0,0.10)]" [attr.data-testid]="card.testId">
          <div class="flex flex-col h-full justify-between">
            <!-- Card Header -->
            <div class="flex items-center gap-2">
              <i [class]="card.icon + ' w-4 h-4 text-muted-foreground'"></i>
              <h4>{{ card.title }}</h4>
            </div>

            <!-- Custom Content -->
            @switch (card.customContentType) {
              <!-- Sparkline Chart -->
              @case ('sparkline') {
                @if (card.chartData) {
                  <div class="mt-3 w-full h-16">
                    <lfx-chart [type]="'line'" [data]="card.chartData" [options]="sparklineOptions" height="100%"></lfx-chart>
                  </div>
                }
              }

              <!-- Bar Chart -->
              @case ('bar-chart') {
                @if (card.chartData) {
                  <div class="mt-3 flex justify-center">
                    <div class="w-[200px] h-[60px]">
                      <lfx-chart [type]="'bar'" [data]="card.chartData" [options]="barChartOptions" height="100%"></lfx-chart>
                    </div>
                  </div>
                }
              }

              <!-- Top Projects List -->
              @case ('top-projects') {
                @if (card.topProjects) {
                  <div class="space-y-0.5 p-0 pr-5 pl-[60px] m-0 mb-[5px]">
                    <div class="text-xs font-medium text-muted-foreground">Top 3 Projects by Value</div>
                    @for (project of card.topProjects; track project.name) {
                      <div class="flex items-center justify-between text-sm">
                        <span class="text-muted-foreground">{{ project.name }}</span>
                        <span class="font-medium">{{ project.formattedValue }}</span>
                      </div>
                    }
                  </div>
                }
              }

              <!-- Company Bus Factor (Inline) -->
              @case ('bus-factor') {
                @if (card.busFactor) {
                  <div class="flex-1 flex flex-col justify-end pb-2">
                    <div class="flex gap-0">
                      <!-- Top Companies Section -->
                      <div [style.width.%]="card.busFactor.topCompaniesPercentage" class="flex flex-col gap-1">
                        <div class="text-xs font-medium text-slate-700">
                          {{ card.busFactor.topCompaniesCount }} Companies ({{ card.busFactor.topCompaniesPercentage }}%)
                        </div>
                        <div class="h-4 rounded-l-sm bg-[#0094FF]"></div>
                      </div>

                      <!-- Other Companies Section -->
                      <div [style.width.%]="card.busFactor.otherCompaniesPercentage" class="flex flex-col gap-1">
                        <div class="text-xs text-slate-600 text-right">{{ card.busFactor.otherCompaniesCount }} Other Companies</div>
                        <div class="h-4 bg-slate-200 rounded-r-sm"></div>
                      </div>
                    </div>
                  </div>
                }
              }

              <!-- Project Health Scores -->
              @case ('health-scores') {
                @if (card.healthScores) {
                  <div class="flex-1 flex flex-col justify-end p-0">
                    <div class="flex items-end justify-between gap-2 h-16">
                      @for (item of healthScoreDistribution(); track item.category) {
                        <div class="flex-1 flex flex-col items-center gap-1">
                          <div
                            class="w-full rounded-t transition-all hover:opacity-80"
                            [style.backgroundColor]="item.color"
                            [style.height.px]="item.heightPx"></div>
                          <div class="text-[10px] text-center whitespace-nowrap">
                            <div class="font-medium">{{ item.category }}</div>
                            <div class="text-muted-foreground">{{ item.count }}</div>
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                }
              }
            }

            <!-- Card Footer (Value and Subtitle) -->
            @if (card.value || card.subtitle) {
              <div class="space-y-1">
                @if (card.value) {
                  <div class="text-xl font-medium">{{ card.value }}</div>
                }
                @if (card.subtitle) {
                  <div class="text-xs text-muted-foreground">{{ card.subtitle }}</div>
                }
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>
</section>
