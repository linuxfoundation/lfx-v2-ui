<!-- Copyright The Linux Foundation and each contributor to LFX. -->
<!-- SPDX-License-Identifier: MIT -->

@if (meeting()) {
  <div class="bg-gray-50">
    <!-- Main Content -->
    <div class="container mx-auto py-6 px-8">
      <div class="max-w-4xl mx-auto">
        <!-- Project Logo -->
        @if (project()?.logo_url) {
          <img src="{{ project()?.logo_url }}" alt="{{ project()?.name }}" class="w-full h-20 mb-6" />
        }

        <!-- Meeting Information Card -->
        <lfx-card class="mb-6" data-testid="meeting-info-card">
          <!-- Header with badges -->
          <div class="flex items-start justify-between mb-4" data-testid="meeting-details-header">
            <div class="flex items-center gap-2 flex-wrap">
              <!-- Privacy Badge -->
              @if (meeting().visibility === 'private') {
                <div class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-red-500 text-white">
                  <i class="fa-light fa-shield"></i>
                  <span>Private</span>
                </div>
              }

              <!-- Meeting Type Badge -->
              @if (meetingTypeBadge(); as badge) {
                <div class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium" [class]="badge.badgeClass">
                  @if (badge.icon) {
                    <i [class]="badge.icon"></i>
                  }
                  <span>{{ badge.text }}</span>
                </div>
              }

              <!-- Recurring Badge -->
              @if (meeting().recurrence) {
                <div
                  class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-gray-400 text-white"
                  [pTooltip]="meeting().recurrence | recurrenceSummary"
                  data-testid="recurring-badge">
                  <i class="fa-light fa-repeat"></i>
                  <span>Recurring</span>
                </div>
              }
            </div>
          </div>

          <!-- Meeting Title and Date -->
          <div class="flex sm:flex-row flex-col items-start justify-between mb-4" data-testid="meeting-title-section">
            <div class="flex-1 pr-4 flex-grow">
              <h2 class="text-xl font-display font-semibold text-gray-900 mb-1 leading-tight" data-testid="meeting-title">
                {{ currentOccurrence()?.title || meeting().title }}
              </h2>
            </div>
            @if (currentOccurrence()?.start_time || meeting().start_time; as startTime) {
              <div class="flex items-center gap-1 text-xs text-gray-600 bg-gray-100 px-2 py-1 rounded flex-shrink-0" data-testid="meeting-datetime">
                <i class="fa-light fa-calendar-days text-gray-400"></i>
                <span
                  >{{ startTime | meetingTime: currentOccurrence()?.duration || meeting().duration : 'date' }} â€¢
                  {{ startTime | meetingTime: currentOccurrence()?.duration || meeting().duration : 'time' }}</span
                >
              </div>
            }
          </div>

          <!-- Meeting Agenda -->
          @if (currentOccurrence()?.description || meeting().description; as description) {
            <div class="mb-4" data-testid="meeting-description">
              <div class="flex items-center gap-2 mb-2">
                <i class="fa-light fa-file-lines text-gray-400"></i>
                <span class="text-sm font-medium text-gray-700 font-sans">Meeting Description</span>
              </div>
              <lfx-expandable-text [maxHeight]="85">
                <div class="text-sm text-gray-600 leading-relaxed bg-gray-50 rounded-lg p-3">
                  <div [innerHTML]="description | linkify"></div>
                </div>
              </lfx-expandable-text>
            </div>
          }

          <!-- Important Links -->
          @if (importantLinks().length > 0) {
            <div class="mb-4" data-testid="important-links">
              <div class="flex items-center gap-2 mb-2">
                <i class="fa-light fa-link text-gray-400"></i>
                <span class="text-sm font-medium text-gray-700 font-sans">Important Links</span>
              </div>
              <div class="flex flex-wrap gap-2">
                @for (link of importantLinks(); track link.url) {
                  <a
                    size="small"
                    class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 hover:bg-gray-200 text-xs rounded transition-colors"
                    [href]="link.url"
                    target="_blank"
                    rel="noopener noreferrer"
                    [title]="link.url">
                    <i class="fa-light fa-external-link"></i>
                    {{ link.domain }}
                  </a>
                }
              </div>
            </div>
          }

          <!-- Meeting Info Cards -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 py-4 border-y border-gray-200 mb-4" data-testid="meeting-info-cards">
            <!-- Attendees Card -->
            <div class="bg-gray-50 rounded-lg p-3 space-y-2" data-testid="attendees-card">
              <div class="flex items-center gap-2 text-xs text-gray-500">
                <i class="fa-light fa-users text-gray-400"></i>
                <span>Guests</span>
              </div>
              <div class="space-y-2">
                <div class="text-sm font-sans">{{ (meeting().individual_registrants_count || 0) + (meeting().committee_members_count || 0) }} invited</div>
              </div>
            </div>

            <!-- Platform Card -->
            <div class="bg-gray-50 rounded-lg p-3 space-y-2" data-testid="platform-card">
              <div class="flex items-center gap-2 text-xs text-gray-500">
                <i class="fa-light fa-video text-gray-400"></i>
                <span>Platform</span>
              </div>
              <div class="flex items-center gap-2">
                <img src="/images/zoom-logo.svg" alt="Zoom" class="w-auto h-4 mt-2 object-contain" />
              </div>
            </div>

            <!-- Duration Card -->
            <div class="bg-gray-50 rounded-lg p-3 space-y-2" data-testid="duration-card">
              <div class="flex items-center gap-2 text-xs text-gray-500">
                <i class="fa-light fa-clock text-gray-400"></i>
                <span>Duration</span>
              </div>
              <div class="text-sm font-sans">{{ currentOccurrence()?.duration || meeting().duration }} minutes</div>
            </div>
          </div>

          <!-- Meeting Attachments -->
          @if (attachments().length > 0) {
            <div class="mb-4" data-testid="meeting-attachments">
              <div class="flex items-center gap-2 mb-2">
                <i class="fa-light fa-paperclip text-gray-400"></i>
                <span class="text-sm font-medium text-gray-700 font-sans">Meeting Attachments</span>
              </div>
              <div class="space-y-2">
                @for (attachment of attachments(); track attachment.id; let i = $index) {
                  <div
                    class="flex items-center justify-between p-3 bg-gray-50 border border-gray-200 rounded-lg"
                    [attr.data-testid]="'meeting-attachment-' + i">
                    <div class="flex items-center gap-3">
                      <div class="p-2 bg-blue-100 rounded-lg">
                        <i class="fa-light fa-file text-blue-600"></i>
                      </div>
                      <div>
                        <p class="text-sm font-medium text-gray-900 font-sans">{{ attachment.file_name }}</p>
                        <p class="text-xs text-gray-500 font-sans">
                          @if (attachment.file_size) {
                            {{ attachment.file_size | fileSize }}
                          }
                        </p>
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      @if (attachment.file_url) {
                        <a
                          [href]="attachment.file_url"
                          target="_blank"
                          rel="noopener noreferrer"
                          class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 hover:bg-blue-200 text-xs text-blue-700 rounded transition-colors"
                          [attr.data-testid]="'download-attachment-' + i">
                          <i class="fa-light fa-download"></i>
                          <span>Download</span>
                        </a>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Join Section -->
          <div data-testid="join-section">
            <div class="flex items-center gap-2 mb-3">
              <i class="fa-light fa-user-plus text-gray-400"></i>
              <h3 class="text-lg font-display font-semibold text-gray-900">Join This Meeting</h3>
            </div>

            @if (authenticated() && user(); as user) {
              <!-- Logged In State -->
              <div class="flex flex-col gap-3">
                <div class="bg-blue-50 p-3 rounded-lg">
                  <div class="flex items-start justify-between">
                    <div class="flex items-center gap-3">
                      <div class="w-8 h-8 bg-blue-400 rounded-full flex items-center justify-center">
                        <i class="fa-light fa-user text-white text-xs"></i>
                      </div>
                      <div>
                        <h4 class="font-medium text-gray-900 font-sans">{{ user.name }}</h4>
                        <p class="text-sm text-gray-600 font-sans">{{ user.email }}</p>
                      </div>
                    </div>
                    <a href="/logout?returnTo={{ returnTo() }}" class="text-primary flex gap-2 items-center text-xs">
                      <i class="fa-light fa-sign-out"></i>
                      <span>Logout</span>
                    </a>
                  </div>
                </div>

                <lfx-message
                  [severity]="messageSeverity()"
                  [icon]="messageIcon()"
                  styleClass="flex items-center justify-between w-full"
                  [attr.data-testid]="'join-status-message'">
                  <ng-template #content>
                    <div class="flex items-center justify-between w-full">
                      <div class="flex items-center gap-3 text-sm">
                        @if (hasAutoJoined()) {
                          <span class="font-sans">Meeting opened in a new tab. If it didn't open, use the button to join manually.</span>
                        } @else if (canJoinMeeting()) {
                          <span class="font-sans">Ready to join as {{ user.name }}</span>
                        } @else {
                          <div class="flex flex-col">
                            <span class="font-sans"
                              >You may only join the meeting up to <span class="font-bold">{{ meeting().early_join_time_minutes || 10 }} minutes</span> before
                              the start time.</span
                            >
                          </div>
                        }
                      </div>
                      <div class="ml-4">
                        <lfx-button
                          size="small"
                          severity="primary"
                          label="Join Meeting"
                          [disabled]="!canJoinMeeting()"
                          icon="fa-light fa-sign-in"
                          [attr.data-testid]="'join-meeting-button-authenticated'"
                          (click)="onJoinMeeting()"></lfx-button>
                      </div>
                    </div>
                  </ng-template>
                </lfx-message>

                <div class="text-center">
                  <p class="text-xs text-gray-500 font-sans flex gap-1 items-center justify-center">
                    <span>Not you?</span>
                    <a class="text-primary" href="/logout?returnTo={{ returnTo() }}"> Use a different account </a>
                  </p>
                </div>
              </div>
            } @else {
              <!-- Not Logged In State -->
              <div class="space-y-4">
                <!-- Sign In Option -->
                <lfx-message severity="info" icon="fa-light fa-sign-in">
                  <ng-template #content>
                    <div class="flex items-center justify-between w-full">
                      <div>
                        <h4 class="font-medium text-gray-900 font-sans mb-1">Sign in with your LFX account</h4>
                        <p class="text-sm text-gray-600 font-sans">Join quickly with your saved information</p>
                      </div>
                      <a
                        size="small"
                        class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 hover:bg-gray-200 text-xs rounded transition-colors ml-4"
                        [href]="'/login?returnTo=' + returnTo()">
                        <i class="fa-light fa-sign-in"></i>
                        <span>Sign In</span>
                      </a>
                    </div>
                  </ng-template>
                </lfx-message>

                <!-- OR Divider -->
                <div class="relative">
                  <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                  </div>
                  <div class="relative flex justify-center text-xs uppercase">
                    <span class="bg-white px-2 text-gray-500 font-sans">OR</span>
                  </div>
                </div>

                <!-- Manual Entry Form -->
                <div class="flex flex-col gap-3">
                  <h4 class="font-medium text-gray-900 font-sans">Enter your information</h4>

                  <form [formGroup]="joinForm" class="flex flex-col gap-3">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                      <div>
                        <label for="name" class="flex items-center gap-1 text-sm font-medium text-gray-700 font-sans mb-1">
                          <i class="fa-light fa-user text-xs"></i>
                          Full Name
                          <span class="text-red-500">*</span>
                        </label>
                        <lfx-input-text id="name" [form]="joinForm" control="name" placeholder="John Doe" styleClass="w-full" size="small"> </lfx-input-text>
                      </div>

                      <div>
                        <label for="email" class="flex items-center gap-1 text-sm font-medium text-gray-700 font-sans mb-1">
                          <i class="fa-light fa-envelope text-xs"></i>
                          Email
                          <span class="text-red-500">*</span>
                        </label>
                        <lfx-input-text id="email" [form]="joinForm" control="email" placeholder="john.doe@example.com" styleClass="w-full" size="small">
                        </lfx-input-text>
                      </div>

                      <div class="md:col-span-2">
                        <label for="organization" class="flex items-center gap-1 text-sm font-medium text-gray-700 font-sans mb-1">
                          <i class="fa-light fa-building text-xs"></i>
                          Organization
                        </label>
                        <lfx-input-text id="organization" [form]="joinForm" control="organization" placeholder="Your Company" styleClass="w-full" size="small">
                        </lfx-input-text>
                      </div>
                    </div>

                    <div class="flex items-center" [ngClass]="{ 'justify-between': !canJoinMeeting(), 'justify-end': canJoinMeeting() }">
                      @if (!canJoinMeeting()) {
                        <div class="flex items-center gap-2 text-sm" [ngClass]="{ 'text-blue-700': canJoinMeeting(), 'text-amber-700': !canJoinMeeting() }">
                          <i class="fa-light fa-clock text-amber-600"></i>
                          <div class="flex flex-col">
                            <span class="font-sans text-amber-700"
                              >You may only join the meeting up to <span class="font-bold">{{ meeting().early_join_time_minutes || 10 }} minutes</span> before
                              the start time.</span
                            >
                          </div>
                        </div>
                      }
                      <div class="flex items-center">
                        <lfx-button
                          size="small"
                          severity="primary"
                          label="Join Meeting"
                          [disabled]="joinForm.invalid || !canJoinMeeting()"
                          icon="fa-light fa-sign-in"
                          [attr.data-testid]="'join-meeting-button-form'"
                          (click)="onJoinMeeting()"></lfx-button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            }
          </div>
        </lfx-card>
      </div>
    </div>

    <!-- Toast messages -->
    <p-toast></p-toast>
  </div>
}
