# Copyright The Linux Foundation and each contributor to LFX.
# SPDX-License-Identifier: MIT
---
name: Deploy Branch to Development

on:
  pull_request:
    types: [closed, labeled, unlabeled, synchronize]

permissions:
  contents: read
  packages: write
  pull-requests: write
  issues: write
  id-token: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    # Only build a container if the PR is still open, it's labeled with
    # 'deploy-preview' and does not come from a fork.
    if: >
      github.event.action != 'closed' &&
      github.event.pull_request.state == 'open' &&
      github.event.pull_request.head.repo.fork == false &&
      contains(github.event.pull_request.labels.*.name, 'deploy-preview')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: OIDC Auth for AWS
        uses: aws-actions/configure-aws-credentials@v4
        id: oidc-auth
        with:
          audience: sts.amazonaws.com
          role-to-assume: arn:aws:iam::788942260905:role/github-actions-deploy
          aws-region: us-west-2

      - name: Read secrets from AWS Secrets Manager into environment variables
        id: get_secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            LAUNCHDARKLY, /cloudops/managed-secrets/launchdarkly/lfx_one/ld_client_id

      - name: Validate required secrets for Docker build
        id: validate-secrets
        run: |
          missing_secrets=""

          # Check AWS Secrets Manager secrets (masked environment variables)
          if [ -z "$LAUNCHDARKLY" ]; then
            missing_secrets="$missing_secrets LAUNCHDARKLY (from AWS Secrets Manager)"
          else
            LD_CLIENT_ID=$(echo "$LAUNCHDARKLY" | jq -r '.ld_client_id // empty')
            if [ -z "$LD_CLIENT_ID" ]; then
              missing_secrets="$missing_secrets LAUNCHDARKLY.ld_client_id (from AWS Secrets Manager)"
            fi
          fi

          if [ -n "$missing_secrets" ]; then
            echo "âŒ Missing required secrets for Docker build:$missing_secrets"
            echo "Please configure these secrets to run docker build."
            exit 1
          else
            echo "âœ… All required secrets are configured"
            exit 0
          fi
      
      - name: Set up sensitive environment variables
        run: |
          # Parse and set LaunchDarkly secrets with explicit masking
          if [ -n "$LAUNCHDARKLY" ]; then
            LD_CLIENT_ID=$(echo "$LAUNCHDARKLY" | jq -r '.ld_client_id // empty')

            # Explicitly mask the values
            echo "::add-mask::$LD_CLIENT_ID"
            echo "LD_CLIENT_ID=$LD_CLIENT_ID" >> $GITHUB_ENV
          fi


      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=pr,prefix=ui-pr-
          labels: |
            org.opencontainers.image.title=LFX One UI
            org.opencontainers.image.description=Linux Foundation LFX One UI application
            org.opencontainers.image.vendor=The Linux Foundation
            org.opencontainers.image.licenses=MIT
            org.opencontainers.image.documentation=https://github.com/${{ github.repository }}/blob/main/README.md
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            com.github.actions.run_id=${{ github.run_id }}
            com.github.actions.run_number=${{ github.run_number }}
            com.github.actions.workflow=${{ github.workflow }}

      - name: Build and push Docker image
        id: docker-build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_ENV=development
          secret-envs: |
            LD_CLIENT_ID=LD_CLIENT_ID

      - name: Comment deployment URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = `https://ui-pr-${{ github.event.pull_request.number }}.dev.v2.cluster.linuxfound.info`;
            const comment = `## ðŸš€ Deployment Status

            Your branch has been deployed to: ${deploymentUrl}

            **Deployment Details:**
            - Environment: Development
            - Namespace: ui-pr-${{ github.event.pull_request.number }}
            - ArgoCD App: ui-pr-${{ github.event.pull_request.number }}

            The deployment will be automatically removed when this PR is closed.`;

            // Check if we already commented
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## ðŸš€ Deployment Status')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  cleanup-on-close:
    if: >
      (
        (github.event.action == 'closed' && contains(github.event.pull_request.labels.*.name, 'deploy-preview')) ||
        (github.event.action == 'unlabeled' && github.event.label.name == 'deploy-preview')
      )
    runs-on: ubuntu-latest
    steps:
      - name: Comment removal on PR
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ðŸ§¹ Deployment Removed

            The deployment for PR #${{ github.event.pull_request.number }} has been removed.`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
