# Copyright The Linux Foundation and each contributor to LFX.
# SPDX-License-Identifier: MIT

name: E2E Tests

permissions:
  id-token: write
  contents: read
  issues: write
  pull-requests: write

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: false
        default: '22'
        type: string
      test-command:
        description: 'Test command to run'
        required: false
        default: 'e2e'
        type: string
      browser:
        description: 'Browser to test (chromium, firefox, mobile-chrome, or all)'
        required: false
        default: 'all'
        type: string
      base-url:
        description: 'Base URL for testing'
        required: false
        default: 'http://localhost:4200'
        type: string
      skip-build:
        description: 'Skip building the application (use existing build)'
        required: false
        default: false
        type: boolean
      shard-count:
        description: 'Number of shards for parallel execution (2-8)'
        required: false
        default: 4
        type: number
    secrets:
      TEST_USERNAME:
        description: 'Username for test authentication'
        required: false
      TEST_PASSWORD:
        description: 'Password for test authentication'
        required: false
      AI_API_KEY:
        description: 'API key for AI'
        required: false
      AI_PROXY_URL:
        description: 'Proxy URL for AI'
        required: false
    outputs:
      test-results:
        description: 'Test results summary'
        value: ${{ jobs.e2e-tests.outputs.test-results }}

jobs:
  # Setup job - runs once to prepare shared artifacts
  setup:
    name: Setup Dependencies and Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      can-run-tests: ${{ steps.validate-secrets.outputs.can_run_tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --immutable

      - name: OIDC Auth
        uses: aws-actions/configure-aws-credentials@v4
        id: oidc-auth
        with:
          audience: sts.amazonaws.com
          role-to-assume: arn:aws:iam::788942260905:role/github-actions-deploy
          aws-region: us-west-2

      - name: Read secrets from AWS Secrets Manager into environment variables
        id: get_secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            SUPABASE, /cloudops/managed-secrets/cloud/supabase/api_key
            AUTH0,  /cloudops/managed-secrets/auth0/LFX_V2_PCC
            AUTH,  /cloudops/managed-secrets/auth0/LFX_V2_Meeting_Join_M2M

      - name: Validate required secrets for E2E testing
        id: validate-secrets
        run: |
          missing_secrets=""

          # Check AWS Secrets Manager secrets (masked environment variables)
          if [ -z "$AUTH0" ]; then
            missing_secrets="$missing_secrets AUTH0 (from AWS Secrets Manager)"
          else
            AUTH0_CLIENT_ID=$(echo "$AUTH0" | jq -r '.client_id // empty')
            AUTH0_CLIENT_SECRET=$(echo "$AUTH0" | jq -r '.client_secret // empty')
            if [ -z "$AUTH0_CLIENT_ID" ] || [ -z "$AUTH0_CLIENT_SECRET" ]; then
              missing_secrets="$missing_secrets AUTH0.client_id or AUTH0.client_secret (from AWS Secrets Manager)"
            fi
          fi
          if [ -z "$SUPABASE" ]; then
            missing_secrets="$missing_secrets SUPABASE (from AWS Secrets Manager)"
          else
            SUPABASE_URL=$(echo "$SUPABASE" | jq -r '.url // empty')
            SUPABASE_API_KEY=$(echo "$SUPABASE" | jq -r '.api_key // empty')
            if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_API_KEY" ]; then
              missing_secrets="$missing_secrets SUPABASE.url or SUPABASE.api_key (from AWS Secrets Manager)"
            fi
          fi
          if [ -z "$AUTH" ]; then
            missing_secrets="$missing_secrets AUTH (from AWS Secrets Manager)"
          else
            M2M_AUTH_CLIENT_ID=$(echo "$AUTH" | jq -r '.m2m_client_id // empty')
            M2M_AUTH_CLIENT_SECRET=$(echo "$AUTH" | jq -r '.m2m_client_secret // empty')
            if [ -z "$M2M_AUTH_CLIENT_ID" ] || [ -z "$M2M_AUTH_CLIENT_SECRET" ]; then
              missing_secrets="$missing_secrets AUTH.m2m_client_id or AUTH.m2m_client_secret (from AWS Secrets Manager)"
            fi
          fi

          # Check GitHub secrets (fallback)
          if [ -z "${{ secrets.TEST_USERNAME }}" ]; then
            missing_secrets="$missing_secrets TEST_USERNAME"
          fi
          if [ -z "${{ secrets.TEST_PASSWORD }}" ]; then
            missing_secrets="$missing_secrets TEST_PASSWORD"
          fi
          if [ -z "${{ secrets.AI_API_KEY }}" ]; then
            missing_secrets="$missing_secrets AI_API_KEY"
          fi
          if [ -z "${{ secrets.AI_PROXY_URL }}" ]; then
            missing_secrets="$missing_secrets AI_PROXY_URL"
          fi

          if [ -n "$missing_secrets" ]; then
            echo "❌ Missing required secrets for E2E testing:$missing_secrets"
            echo "Please configure these secrets to enable E2E tests."
            echo "can_run_tests=false" >> $GITHUB_OUTPUT
          else
            echo "✅ All required secrets are configured"
            echo "can_run_tests=true" >> $GITHUB_OUTPUT
          fi

      - name: Build the application
        if: steps.validate-secrets.outputs.can_run_tests == 'true' && !inputs.skip-build
        run: yarn build

      - name: Upload build artifacts
        if: steps.validate-secrets.outputs.can_run_tests == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            packages/shared/dist/
            apps/lfx-pcc/dist/
            node_modules/.cache/
            .turbo/
          retention-days: 1

  # E2E tests - runs in parallel shards after setup
  e2e-tests:
    name: Playwright E2E Tests (Shard ${{ matrix.shard }}/${{ inputs.shard-count }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [setup]
    if: ${{ needs.setup.outputs.can-run-tests == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
    outputs:
      test-results: ${{ steps.test-results.outputs.results }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --immutable

      - name: OIDC Auth
        uses: aws-actions/configure-aws-credentials@v4
        id: oidc-auth
        with:
          audience: sts.amazonaws.com
          role-to-assume: arn:aws:iam::788942260905:role/github-actions-deploy
          aws-region: us-west-2

      - name: Read secrets from AWS Secrets Manager into environment variables
        id: get_secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            SUPABASE, /cloudops/managed-secrets/cloud/supabase/api_key
            AUTH0,  /cloudops/managed-secrets/auth0/LFX_V2_PCC
            AUTH,  /cloudops/managed-secrets/auth0/LFX_V2_Meeting_Join_M2M

      - name: Set up environment variables
        run: |
          echo "ENV=development" >> $GITHUB_ENV
          echo "PCC_BASE_URL=http://localhost:4200" >> $GITHUB_ENV
          echo "PCC_AUTH0_ISSUER_BASE_URL=https://linuxfoundation-dev.auth0.com/" >> $GITHUB_ENV
          echo "PCC_AUTH0_AUDIENCE=https://api-gw.dev.platform.linuxfoundation.org/" >> $GITHUB_ENV
          echo "LFX_V2_SERVICE=http://lfx-api.dev.v2.cluster.linuxfound.info" >> $GITHUB_ENV
          echo "NATS_URL=nats://lfx-platform-nats.lfx.svc.cluster.local:4222" >> $GITHUB_ENV
          echo "M2M_AUTH_ISSUER_BASE_URL=https://linuxfoundation-dev.auth0.com/" >> $GITHUB_ENV
          echo "M2M_AUTH_AUDIENCE=https://api-gw.dev.platform.linuxfoundation.org/" >> $GITHUB_ENV
          echo "CI=true" >> $GITHUB_ENV
          
          # Parse and set AUTH0 secrets
          if [ -n "$AUTH0" ]; then
            AUTH0_CLIENT_ID=$(echo "$AUTH0" | jq -r '.client_id // empty')
            AUTH0_CLIENT_SECRET=$(echo "$AUTH0" | jq -r '.client_secret // empty')
            echo "::add-mask::$AUTH0_CLIENT_ID"
            echo "::add-mask::$AUTH0_CLIENT_SECRET"
            echo "PCC_AUTH0_CLIENT_ID=$AUTH0_CLIENT_ID" >> $GITHUB_ENV
            echo "PCC_AUTH0_CLIENT_SECRET=$AUTH0_CLIENT_SECRET" >> $GITHUB_ENV
          fi

          # Parse and set M2M AUTH secrets
          if [ -n "$AUTH" ]; then
            M2M_AUTH_CLIENT_ID=$(echo "$AUTH" | jq -r '.m2m_client_id // empty')
            M2M_AUTH_CLIENT_SECRET=$(echo "$AUTH" | jq -r '.m2m_client_secret // empty')
            echo "::add-mask::$M2M_AUTH_CLIENT_ID"
            echo "::add-mask::$M2M_AUTH_CLIENT_SECRET"
            echo "M2M_AUTH_CLIENT_ID=$M2M_AUTH_CLIENT_ID" >> $GITHUB_ENV
            echo "M2M_AUTH_CLIENT_SECRET=$M2M_AUTH_CLIENT_SECRET" >> $GITHUB_ENV
          fi

          # Parse and set SUPABASE secrets
          if [ -n "$SUPABASE" ]; then
            SUPABASE_URL=$(echo "$SUPABASE" | jq -r '.url // empty')
            SUPABASE_API_KEY=$(echo "$SUPABASE" | jq -r '.api_key // empty')
            echo "::add-mask::$SUPABASE_URL"
            echo "::add-mask::$SUPABASE_API_KEY"
            echo "SUPABASE_URL=$SUPABASE_URL" >> $GITHUB_ENV
            echo "POSTGRES_API_KEY=$SUPABASE_API_KEY" >> $GITHUB_ENV
          fi

          # Set GitHub secrets
          echo "::add-mask::${{ secrets.AI_API_KEY }}"
          echo "::add-mask::${{ secrets.AI_PROXY_URL }}"
          echo "::add-mask::${{ secrets.TEST_USERNAME }}"
          echo "::add-mask::${{ secrets.TEST_PASSWORD }}"
          echo "AI_API_KEY=${{ secrets.AI_API_KEY }}" >> $GITHUB_ENV
          echo "AI_PROXY_URL=${{ secrets.AI_PROXY_URL }}" >> $GITHUB_ENV
          echo "TEST_USERNAME=${{ secrets.TEST_USERNAME }}" >> $GITHUB_ENV
          echo "TEST_PASSWORD=${{ secrets.TEST_PASSWORD }}" >> $GITHUB_ENV

      - name: Setup Playwright with caching
        uses: ./.github/actions/setup-playwright
        with:
          browser: ${{ inputs.browser }}

      - name: Create Playwright auth directory
        working-directory: apps/lfx-pcc
        run: mkdir -p playwright/.auth

      - name: Run E2E tests (All browsers)
        id: run-tests-all
        if: ${{ inputs.browser == 'all' }}
        working-directory: apps/lfx-pcc
        continue-on-error: true
        run: |
          echo "🔐 Running authenticated E2E tests on all browsers"
          echo "🔀 Running with sharding: ${{ matrix.shard }}/${{ inputs.shard-count }}"
          echo "🚀 Playwright will automatically start the dev server on localhost:4200"
          yarn ${{ inputs.test-command }} --reporter=list --shard=${{ matrix.shard }}/${{ inputs.shard-count }}
          echo "test_exit_code=$?" >> $GITHUB_OUTPUT

      - name: Run E2E tests (Specific browser)
        if: ${{ inputs.browser != 'all' }}
        working-directory: apps/lfx-pcc
        run: |
          echo "🔐 Running authenticated E2E tests on ${{ inputs.browser }}"
          echo "🔀 Running with sharding: ${{ matrix.shard }}/${{ inputs.shard-count }}"
          echo "🚀 Playwright will automatically start the dev server on localhost:4200"
          yarn ${{ inputs.test-command }} --project=${{ inputs.browser }} --reporter=list --shard=${{ matrix.shard }}/${{ inputs.shard-count }}

      - name: Generate test results summary
        id: test-results
        if: always()
        working-directory: apps/lfx-pcc
        run: |
          if [ -z "$TEST_USERNAME" ] || [ -z "$TEST_PASSWORD" ]; then
            echo "⏭️ E2E tests skipped (no test credentials)"
            echo "results=skipped" >> $GITHUB_OUTPUT
          elif [ -f "test-results/.last-run.json" ]; then
            echo "✅ E2E tests completed successfully"
            echo "results=success" >> $GITHUB_OUTPUT
          else
            echo "❌ E2E tests failed"
            echo "results=failure" >> $GITHUB_OUTPUT
          fi

      - name: Comment test results on PR
        if: github.event_name == 'pull_request' && matrix.shard == 1 && always()
        uses: actions/github-script@v7
        with:
          script: |
            const results = '${{ steps.test-results.outputs.results }}';
            const browser = '${{ inputs.browser }}';
            const runId = '${{ github.run_id }}';

            let emoji, status, details;
            
            if (results === 'success') {
              emoji = '✅';
              status = 'passed';
              details = 'All E2E tests passed successfully across 4 parallel shards.';
            } else if (results === 'failure') {
              emoji = '❌';
              status = 'failed';
              details = 'Some E2E tests failed. Check the [test report](https://github.com/${{ github.repository }}/actions/runs/' + runId + ') for details.';
            } else {
              emoji = '⏭️';
              status = 'skipped';
              details = 'E2E tests were skipped (no test credentials provided).';
            }
            
            const comment = `## ${emoji} E2E Tests ${status.charAt(0).toUpperCase() + status.slice(1)}
            
            **Browser:** ${browser}
            **Shards:** 4 parallel executions
            **Status:** ${status}
            
            ${details}
            
            <details>
            <summary>Test Configuration</summary>
            
            - **Node.js:** ${{ inputs.node-version }}
            - **Command:** \`${{ inputs.test-command }}\`
            - **Browser:** ${browser}
            - **Base URL:** ${{ inputs.base-url }}
            - **Shards:** ${{ inputs.shard-count }}
            
            </details>`;
            
            // Look for existing E2E test comment by this bot
            const existingComments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const botComment = existingComments.data.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('## ') && 
              comment.body.includes('E2E Tests')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              console.log('Updated existing E2E test comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              console.log('Created new E2E test comment');
            }