# Copyright The Linux Foundation and each contributor to LFX.
# SPDX-License-Identifier: MIT

name: Get LaunchDarkly Secrets

on:
  workflow_call:
    outputs:
      ld_client_id:
        description: 'LaunchDarkly client ID from AWS Secrets Manager'
        value: ${{ jobs.get-secrets.outputs.ld_client_id }}

permissions:
  id-token: write
  contents: read

jobs:
  get-secrets:
    runs-on: ubuntu-latest
    outputs:
      ld_client_id: ${{ steps.set-output.outputs.ld_client_id }}

    steps:
      - name: OIDC Auth
        uses: aws-actions/configure-aws-credentials@v4
        id: oidc-auth
        with:
          audience: sts.amazonaws.com
          role-to-assume: arn:aws:iam::788942260905:role/github-actions-deploy
          aws-region: us-west-2

      - name: Read secrets from AWS Secrets Manager into environment variables
        id: get_secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            LAUNCHDARKLY, /cloudops/managed-secrets/launchdarkly/lfx_one/ld_client_id

      - name: Validate required secrets for Docker build
        id: validate-secrets
        run: |
          missing_secrets=""

          # Check AWS Secrets Manager secrets (masked environment variables)
          if [ -z "$LAUNCHDARKLY" ]; then
            missing_secrets="$missing_secrets LAUNCHDARKLY (from AWS Secrets Manager)"
          else
            LAUNCHDARKLY_CLIENT_ID=$(echo "$LAUNCHDARKLY" | jq -r '.ld_client_id // empty')
            if [ -z "$LAUNCHDARKLY_CLIENT_ID" ]; then
              missing_secrets="$missing_secrets LAUNCHDARKLY.ld_client_id (from AWS Secrets Manager)"
            fi
          fi

          if [ -n "$missing_secrets" ]; then
            echo "❌ Missing required secrets for Docker build:$missing_secrets"
            echo "Please configure these secrets to run docker build."
            exit 1
          else
            echo "✅ All required secrets are configured"
            exit 0
          fi

      - name: Set up sensitive environment variables and output
        id: set-output
        run: |
          # Parse and set LaunchDarkly secrets with explicit masking
          if [ -n "$LAUNCHDARKLY" ]; then
            LAUNCHDARKLY_CLIENT_ID=$(echo "$LAUNCHDARKLY" | jq -r '.ld_client_id // empty')

            # Explicitly mask the values
            echo "::add-mask::$LAUNCHDARKLY_CLIENT_ID"

            # Set as output for calling workflow
            echo "ld_client_id=$LAUNCHDARKLY_CLIENT_ID" >> $GITHUB_OUTPUT
          fi
